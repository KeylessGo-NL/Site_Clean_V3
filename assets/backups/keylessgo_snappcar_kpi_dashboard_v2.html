<!DOCTYPE html>
<html lang="nl" class="h-full scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KeylessGo – SnappCar KPI Dashboard (v2)</title>
  <meta name="description" content="Uitgebreid KPI-dashboard voor SnappCar/KeylessGo. Upload Excel of gebruik demo-data. KPI's: omzet, boekingen, huurdagen, km, kosten & resultaat.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            kgo: { blue: '#1A2C49', orange: '#FF7A00', ink: '#0B1220' }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.08)',
            glow: '0 8px 30px rgba(255,122,0,.20)'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(26,44,73,.35); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(26,44,73,.55); }

    .card { border: 1px solid rgba(15,23,42,.10); }
    .chip { border: 1px solid rgba(15,23,42,.12); }
    .glass { background: rgba(255,255,255,.75); backdrop-filter: blur(10px); }
    .mono { font-variant-numeric: tabular-nums; }

    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: rgba(15,23,42,.04); }
    .pill { border: 1px solid rgba(15,23,42,.10); }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-900">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-slate-200/70 bg-white/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-kgo-blue text-white grid place-items-center shadow-soft">
            <span class="font-extrabold">K</span>
          </div>
          <div>
            <h1 class="text-lg sm:text-xl font-extrabold tracking-tight text-kgo-blue">KeylessGo – SnappCar KPI Dashboard</h1>
            <p class="text-xs sm:text-sm text-slate-500">v2 • omzet + boekingen + huurdagen + km + kosten → resultaat</p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnUseDemo" class="hidden sm:inline-flex items-center gap-2 rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow-soft hover:opacity-95">
            <span>Demo laden</span>
          </button>
          <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl bg-kgo-blue px-3 py-2 text-sm font-semibold text-white shadow-soft hover:opacity-95">
            <input id="fileInput" type="file" accept=".xlsx,.xls" class="hidden"/>
            <span>Excel upload</span>
          </label>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
    <!-- Alert -->
    <div id="alert" class="mb-6 hidden rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
      <span class="font-semibold">Let op:</span>
      <span id="alertText"></span>
    </div>

    <!-- Control bar -->
    <section class="mb-6 grid grid-cols-1 gap-4 lg:grid-cols-12">
      <div class="card glass rounded-2xl p-4 shadow-soft lg:col-span-9">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
          <div class="flex-1">
            <h2 class="text-sm font-bold text-slate-700">Filters & keuzes</h2>
            <p class="text-xs text-slate-500">Snelle presets + slimme filters. Alles hieronder (KPI’s, charts, tabel) rekent live.</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="btnPresetYTD" class="pill rounded-xl bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50">YTD</button>
            <button id="btnPreset90" class="pill rounded-xl bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50">Laatste 90 dagen</button>
            <button id="btnPreset30" class="pill rounded-xl bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50">Laatste 30 dagen</button>
            <button id="btnReset" class="pill rounded-xl bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50">Reset</button>
            <button id="btnExportCsv" class="pill rounded-xl bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50">Export CSV (filtered)</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-6">
          <div class="lg:col-span-2">
            <label class="text-xs font-semibold text-slate-600">Periode</label>
            <div class="mt-1 grid grid-cols-2 gap-2">
              <input id="fromDate" type="date" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"/>
              <input id="toDate" type="date" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"/>
            </div>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Hotspot</label>
            <select id="hotspotSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"></select>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Type</label>
            <select id="typeSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"></select>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Voertuig</label>
            <select id="vehicleSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"></select>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Min rating</label>
            <select id="minRatingSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40">
              <option value="0" selected>Geen</option>
              <option value="4">≥ 4.0</option>
              <option value="4.5">≥ 4.5</option>
              <option value="4.8">≥ 4.8</option>
              <option value="4.9">≥ 4.9</option>
            </select>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-6">
          <div class="lg:col-span-2">
            <label class="text-xs font-semibold text-slate-600">Zoek</label>
            <input id="searchInput" placeholder="Zoek: Booking_ID, voertuig, hotspot, model..." class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40"/>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Min huurdagen</label>
            <select id="minDaysSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-kgo-orange/40">
              <option value="0" selected>Geen</option>
              <option value="1">≥ 1</option>
              <option value="2">≥ 2</option>
              <option value="3">≥ 3</option>
              <option value="4">≥ 4</option>
            </select>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Sortering</label>
            <select id="sortSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
              <option value="start_desc" selected>Startdatum (nieuw→oud)</option>
              <option value="start_asc">Startdatum (oud→nieuw)</option>
              <option value="netto_desc">Netto omzet (hoog→laag)</option>
              <option value="netto_asc">Netto omzet (laag→hoog)</option>
              <option value="days_desc">Huurdagen (hoog→laag)</option>
              <option value="rating_desc">Rating (hoog→laag)</option>
            </select>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-600">Toon regels</label>
            <select id="limitSel" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="250">250</option>
              <option value="999999">Alles</option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label class="text-xs font-semibold text-slate-600">Kostenmodel (dashboard)</label>
            <div class="mt-1 grid grid-cols-3 gap-2">
              <input id="feePct" type="number" step="0.1" value="18" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" title="Platform fee % (SnappCar + verwerking)"/>
              <input id="varPerDay" type="number" step="0.1" value="6.5" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" title="Variabele kosten per huurdag (schoonmaak, logistiek, kleine kosten)"/>
              <input id="fixedPerVeh" type="number" step="1" value="460" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" title="Vaste kosten per voertuig per maand (lease/verzekering/onderhoud/keyless)"/>
            </div>
            <div class="mt-1 text-[11px] text-slate-500">
              Fee% standaard hoger gezet zodat het verschil bruto↔netto realistischer is. Pas aan naar jouw model.
            </div>
          </div>
        </div>
      </div>

      <div class="card glass rounded-2xl p-4 shadow-soft lg:col-span-3">
        <h2 class="text-sm font-bold text-slate-700">Data status</h2>
        <p id="dataStatus" class="mt-1 text-xs text-slate-500">Nog geen data geladen.</p>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <div class="rounded-2xl bg-white p-3 shadow-soft">
            <div class="text-xs text-slate-500">Records</div>
            <div id="statRecords" class="mono text-xl font-extrabold text-slate-900">—</div>
          </div>
          <div class="rounded-2xl bg-white p-3 shadow-soft">
            <div class="text-xs text-slate-500">Voertuigen</div>
            <div id="statVehicles" class="mono text-xl font-extrabold text-slate-900">—</div>
          </div>
        </div>

        <div class="mt-3 rounded-2xl bg-kgo-blue p-3 text-white shadow-glow">
          <div class="text-xs text-white/80">Partner+ targets (richting)</div>
          <div class="mt-1 grid grid-cols-2 gap-2 text-xs">
            <div class="rounded-xl bg-white/10 p-2">
              <div class="text-white/70">Avg rating</div>
              <div class="mono font-extrabold">≥ 4.8</div>
            </div>
            <div class="rounded-xl bg-white/10 p-2">
              <div class="text-white/70">Reactietijd</div>
              <div class="mono font-extrabold">&lt; 5 min</div>
            </div>
          </div>
        </div>

        <div class="mt-3 text-xs text-slate-500">
          <span class="font-semibold">Km-data:</span> als je Excel geen Distance/KM-kolom heeft, schat het dashboard km op basis van type (auto/bus/EV).
        </div>
      </div>
    </section>

    <!-- KPI cards -->
    <section class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-6">
      <div class="card rounded-2xl bg-white p-4 shadow-soft">
        <div class="text-xs text-slate-500">Boekingen</div>
        <div id="kpiBookings" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div id="kpiBookingsSub" class="mt-2 text-xs text-slate-500">—</div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft">
        <div class="text-xs text-slate-500">Huurdagen</div>
        <div id="kpiDays" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div id="kpiDaysSub" class="mt-2 text-xs text-slate-500">—</div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft">
        <div class="text-xs text-slate-500">KM totaal</div>
        <div id="kpiKm" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div id="kpiKmSub" class="mt-2 text-xs text-slate-500">—</div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft">
        <div class="text-xs text-slate-500">Bruto omzet</div>
        <div id="kpiBruto" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div class="mt-2 text-xs text-slate-500">Huurdagen × dagprijs</div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft">
        <div class="text-xs text-slate-500">Netto omzet (na fee)</div>
        <div id="kpiNetto" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div id="kpiFee" class="mt-2 text-xs text-slate-500">—</div>
      </div>

      <div class="card rounded-2xl bg-kgo-blue p-4 text-white shadow-glow">
        <div class="text-xs text-white/80">Resultaat (na kosten)</div>
        <div id="kpiResult" class="mono mt-1 text-2xl font-extrabold">—</div>
        <div id="kpiResultSub" class="mt-2 text-xs text-white/80">—</div>
      </div>
    </section>

    <!-- Charts grid: revenue + bookings -->
    <section class="mt-6 grid grid-cols-1 gap-4 xl:grid-cols-12">
      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-8">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-extrabold text-slate-800">Omzet & boekingen over tijd</h3>
            <p class="text-xs text-slate-500">Netto omzet, resultaat en aantal boekingen per periode.</p>
          </div>
          <select id="granularitySel" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700">
            <option value="month" selected>Maand</option>
            <option value="week">Week</option>
          </select>
        </div>
        <div class="mt-3">
          <canvas id="chartTime" height="110"></canvas>
        </div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-4">
        <h3 class="text-sm font-extrabold text-slate-800">Mix: omzet & boekingen per type</h3>
        <p class="text-xs text-slate-500">Auto/Bus + EV apart.</p>
        <div class="mt-3">
          <canvas id="chartType" height="220"></canvas>
        </div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-6">
        <h3 class="text-sm font-extrabold text-slate-800">Hotspots</h3>
        <p class="text-xs text-slate-500">Netto omzet + boekingen per hotspot.</p>
        <div class="mt-3">
          <canvas id="chartHotspots" height="170"></canvas>
        </div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-6">
        <h3 class="text-sm font-extrabold text-slate-800">Voertuigen</h3>
        <p class="text-xs text-slate-500">Top 10 op netto omzet + boekingen.</p>
        <div class="mt-3">
          <canvas id="chartVehicles" height="170"></canvas>
        </div>
      </div>
    </section>

    <!-- Extra KPIs blocks -->
    <section class="mt-6 grid grid-cols-1 gap-4 xl:grid-cols-12">
      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-7">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-extrabold text-slate-800">Hotspot × voertuig (combi’s)</h3>
            <p class="text-xs text-slate-500">Waar zitten de echte winnaars? (netto, resultaat, boekingen, dagen, km)</p>
          </div>
        </div>
        <div class="mt-3 overflow-auto rounded-2xl border border-slate-200">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
              <tr>
                <th class="px-3 py-3">Combi</th>
                <th class="px-3 py-3 text-right">Boekingen</th>
                <th class="px-3 py-3 text-right">Dagen</th>
                <th class="px-3 py-3 text-right">KM</th>
                <th class="px-3 py-3 text-right">Netto</th>
                <th class="px-3 py-3 text-right">Resultaat</th>
              </tr>
            </thead>
            <tbody id="comboTbody" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl bg-white p-4 shadow-soft xl:col-span-5">
        <h3 class="text-sm font-extrabold text-slate-800">Partner+ KPI’s (opbouw)</h3>
        <p class="text-xs text-slate-500">Deze blokken zijn klaar om echte velden te koppelen zodra je ze exporteert.</p>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs text-slate-500">Gem. rating</div>
            <div id="kpiRating" class="mono mt-1 text-xl font-extrabold text-slate-900">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs text-slate-500">Gem. huurdagen</div>
            <div id="kpiAvgDays" class="mono mt-1 text-xl font-extrabold text-slate-900">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs text-slate-500">KM / boeking</div>
            <div id="kpiKmPerBooking" class="mono mt-1 text-xl font-extrabold text-slate-900">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-xs text-slate-500">KM / maand</div>
            <div id="kpiKmPerMonth" class="mono mt-1 text-xl font-extrabold text-slate-900">—</div>
          </div>
        </div>

        <div class="mt-3 rounded-2xl bg-slate-900 p-3 text-white">
          <div class="text-xs text-white/70">Kosten-samenvatting (filtered periode)</div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
            <div class="rounded-xl bg-white/10 p-2">
              <div class="text-white/70">Variabel</div>
              <div id="kpiVarCost" class="mono font-extrabold">—</div>
            </div>
            <div class="rounded-xl bg-white/10 p-2">
              <div class="text-white/70">Vast (allocatie)</div>
              <div id="kpiFixedCost" class="mono font-extrabold">—</div>
            </div>
          </div>
          <div class="mt-2 text-[11px] text-white/70">
            Vast = (# voertuigen in scope × fixedPerVeh × # maanden in periode). Variabel = huurdagen × varPerDay.
          </div>
        </div>
      </div>
    </section>

    <!-- Bookings table -->
    <section class="mt-6 card rounded-2xl bg-white p-4 shadow-soft">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-sm font-extrabold text-slate-800">Boekingen (filtered)</h3>
          <p class="text-xs text-slate-500">Klik op kolomkop om te sorteren. (Tabel sortering is los van dropdown “Sortering”.)</p>
        </div>
        <div class="text-xs text-slate-500">
          Tip: voeg in je echte export later velden toe zoals <span class="font-semibold">DistanceKM</span>, <span class="font-semibold">Accepted</span>, <span class="font-semibold">CancelledByHost</span>, <span class="font-semibold">ResponseTimeSec</span>.
        </div>
      </div>

      <div class="mt-4 overflow-auto rounded-2xl border border-slate-200">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
            <tr>
              <th class="sortable px-3 py-3" data-sort="Booking_ID">Booking</th>
              <th class="sortable px-3 py-3" data-sort="Vehicle_ID">Vehicle</th>
              <th class="sortable px-3 py-3" data-sort="Type">Type</th>
              <th class="sortable px-3 py-3" data-sort="Hotspot">Hotspot</th>
              <th class="sortable px-3 py-3" data-sort="Startdatum">Start</th>
              <th class="sortable px-3 py-3" data-sort="Einddatum">Eind</th>
              <th class="sortable px-3 py-3 text-right" data-sort="Huurdagen">Dagen</th>
              <th class="sortable px-3 py-3 text-right" data-sort="KM">KM</th>
              <th class="sortable px-3 py-3 text-right" data-sort="Netto">Netto</th>
              <th class="sortable px-3 py-3 text-right" data-sort="Resultaat">Resultaat</th>
              <th class="sortable px-3 py-3 text-right" data-sort="Rating">Rating</th>
            </tr>
          </thead>
          <tbody id="bookingsTbody" class="divide-y divide-slate-100 bg-white"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-8 pb-10 text-center text-xs text-slate-500">
      <div class="inline-flex flex-wrap items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2">
        <span class="font-semibold text-slate-700">Tip:</span>
        <span>Upload jouw</span>
        <span class="font-semibold">KeylessGo_SnappCar_KPI_Dashboard_Demo.xlsx</span>
        <span>of laat demo-data draaien.</span>
      </div>
    </footer>
  </main>

  <!-- Details modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative mx-auto mt-16 w-[95vw] max-w-2xl rounded-3xl bg-white p-5 shadow-soft">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h4 class="text-base font-extrabold text-slate-900">Boeking details</h4>
          <p id="modalSub" class="mt-1 text-xs text-slate-500"></p>
        </div>
        <button id="modalClose" class="rounded-xl bg-slate-100 px-3 py-2 text-sm font-bold text-slate-700 hover:bg-slate-200">Sluiten</button>
      </div>
      <div id="modalBody" class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2"></div>
    </div>
  </div>

  <script>
    // =============================
    // State + chart registry
    // =============================
    const REQUIRED_SHEETS = ["Vehicles", "Bookings_Year1"];
    let vehicles = [];
    let bookings = [];
    let filtered = [];
    let filteredForTable = [];

    let tableSort = { key: "Startdatum", dir: "desc" };

    const charts = {
      time: null,
      type: null,
      hotspots: null,
      vehicles: null,
    };

    // =============================
    // Utils
    // =============================
    const fmtEUR = (n) => new Intl.NumberFormat("nl-NL",{style:"currency",currency:"EUR"}).format(Number(n||0));
    const fmtInt = (n) => new Intl.NumberFormat("nl-NL").format(Number(n||0));
    const fmt1 = (n) => (n===null || n===undefined || Number.isNaN(n)) ? "—" : (Math.round(n*10)/10).toFixed(1);
    const fmt0 = (n) => new Intl.NumberFormat("nl-NL").format(Math.round(Number(n||0)));
    const toISODate = (d) => {
      if (!d) return null;
      const dt = (d instanceof Date) ? d : new Date(d);
      if (Number.isNaN(dt.getTime())) return null;
      return dt.toISOString().slice(0,10);
    };
    const safeNum = (v) => {
      if (v === null || v === undefined || v === "") return 0;
      const n = Number(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    };
    const uniq = (arr) => Array.from(new Set(arr)).filter(v => v !== null && v !== undefined && v !== "");
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function showAlert(msg) {
      document.getElementById("alertText").textContent = " " + msg;
      document.getElementById("alert").classList.remove("hidden");
    }
    function hideAlert() {
      document.getElementById("alert").classList.add("hidden");
    }

    // Excel date parsing
    function excelDateToJS(v) {
      if (v instanceof Date) return v;
      if (typeof v === "number") {
        const epoch = new Date(Date.UTC(1899, 11, 30));
        return new Date(epoch.getTime() + v * 86400000);
      }
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function getVehicleById(id) {
      return vehicles.find(v => v.Vehicle_ID === id) || null;
    }

    // =============================
    // KM estimation (if no km column)
    // =============================
    function estimateKm(veh, days) {
      // conservative daily mileage distribution by type
      let base = 60;
      if (!veh) base = 55;
      else if (veh.Brandstof === "EV") base = 55;
      else if (veh.Type === "Bus") base = 45;

      const jitter = 0.75 + Math.random() * 0.70; // 0.75..1.45
      return Math.max(10, Math.round(base * days * jitter));
    }

    // =============================
    // Demo data
    // =============================
    function loadDemo() {
      hideAlert();
      vehicles = [
        {Vehicle_ID:1, Type:"Auto", Merk_Model:"VW Golf", Bouwjaar:2020, Brandstof:"Benzine", Hotspot:"Utrecht Centrum", Dagprijs:69},
        {Vehicle_ID:2, Type:"Auto", Merk_Model:"Toyota Corolla Hybrid", Bouwjaar:2020, Brandstof:"Hybride", Hotspot:"Utrecht Centrum", Dagprijs:65},
        {Vehicle_ID:3, Type:"Auto", Merk_Model:"Skoda Octavia", Bouwjaar:2019, Brandstof:"Benzine", Hotspot:"Utrecht Oost", Dagprijs:72},
        {Vehicle_ID:4, Type:"Auto", Merk_Model:"Hyundai Kona EV", Bouwjaar:2021, Brandstof:"EV", Hotspot:"Utrecht Oost", Dagprijs:75},
        {Vehicle_ID:5, Type:"Bus", Merk_Model:"VW Caddy", Bouwjaar:2019, Brandstof:"Diesel", Hotspot:"Houten", Dagprijs:92},
        {Vehicle_ID:6, Type:"Bus", Merk_Model:"VW Transporter", Bouwjaar:2018, Brandstof:"Diesel", Hotspot:"Houten", Dagprijs:125},
        {Vehicle_ID:7, Type:"Bus", Merk_Model:"Opel Vivaro", Bouwjaar:2020, Brandstof:"Diesel", Hotspot:"Houten", Dagprijs:105},
      ];

      bookings = [];
      const start = new Date("2026-01-01T00:00:00");
      let id = 1;

      function seasonMultiplier(d){
        const m = d.getMonth()+1;
        if ([4,5,6,7,8,9].includes(m)) return 1.18;
        if ([11,12].includes(m)) return 1.10; // moves
        return 0.92;
      }

      for (let day=0; day<365; day++) {
        const dt = new Date(start); dt.setDate(start.getDate()+day);
        const dow = dt.getDay(); // 0 sun
        const weekendBoost = (dow===5 || dow===6) ? 1.20 : 1.0;

        for (const v of vehicles) {
          // tuned so demo has meaningful gaps between bruto/netto and enough volume
          let baseP = 0.11;
          if (v.Type === "Bus") baseP = 0.14;
          if (v.Brandstof === "EV") baseP = 0.115;
          const p = baseP * seasonMultiplier(dt) * weekendBoost;

          if (Math.random() < p) {
            const huur = [1,2,2,3,4,5][Math.floor(Math.random()*6)];
            const end = new Date(dt); end.setDate(dt.getDate()+huur);

            // simple dynamic pricing: busjes in weekend +5%
            const dayPrice = v.Dagprijs * ((v.Type==="Bus" && weekendBoost>1.0) ? 1.05 : 1.0);

            const bruto = huur * dayPrice;
            // "SnappCar fee" will be recalculated using feePct control; store a placeholder
            const rating = [5,5,5,4.9,4.8,4.7,4.5,4.0][Math.floor(Math.random()*8)];

            bookings.push({
              Booking_ID: id++,
              Vehicle_ID: v.Vehicle_ID,
              Startdatum: new Date(dt),
              Einddatum: end,
              Huurdagen: huur,
              Dagprijs: Math.round(dayPrice*100)/100,
              Bruto: bruto,
              Rating: rating,
              KM: estimateKm(v, huur)
            });
          }
        }
      }

      // ensure sufficient volume
      while (bookings.length < 950) {
        const v = vehicles[Math.floor(Math.random()*vehicles.length)];
        const dt = new Date(start); dt.setDate(start.getDate()+Math.floor(Math.random()*365));
        const huur = [1,2,2,3,4,5][Math.floor(Math.random()*6)];
        const end = new Date(dt); end.setDate(dt.getDate()+huur);
        const bruto = huur * v.Dagprijs;
        bookings.push({
          Booking_ID: id++,
          Vehicle_ID: v.Vehicle_ID,
          Startdatum: dt,
          Einddatum: end,
          Huurdagen: huur,
          Dagprijs: v.Dagprijs,
          Bruto: bruto,
          Rating: [5,4.9,4.8,4.7,4.5,4.0][Math.floor(Math.random()*6)],
          KM: estimateKm(v, huur)
        });
      }

      document.getElementById("dataStatus").textContent = "Demo-data geladen (synthetisch + realistische seizoen/weekend patronen).";
      hydrateFilters(true);
      applyFiltersAndRender();
    }

    // =============================
    // Excel loader
    // =============================
    async function handleFile(file) {
      hideAlert();
      if (!file) return;

      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array", cellDates: true });
      const sheetNames = wb.SheetNames || [];

      for (const s of REQUIRED_SHEETS) {
        if (!sheetNames.includes(s)) {
          showAlert(`Sheet '${s}' niet gevonden. Vereist: ${REQUIRED_SHEETS.join(", ")}. Gebruik je template Excel.`);
          return;
        }
      }

      // Vehicles
      const wsV = wb.Sheets["Vehicles"];
      const rawV = XLSX.utils.sheet_to_json(wsV, { defval: "" });
      vehicles = rawV.map(r => ({
        Vehicle_ID: safeNum(r["Vehicle_ID"]),
        Type: String(r["Type"] || "").trim(),
        Merk_Model: String(r["Merk_Model"] || "").trim(),
        Bouwjaar: safeNum(r["Bouwjaar"]),
        Brandstof: String(r["Brandstof"] || "").trim(),
        Hotspot: String(r["Hotspot"] || "").trim(),
        Dagprijs: safeNum(r["Dagprijs"]),
      })).filter(v => v.Vehicle_ID);

      // Bookings: support both the original template columns and optional DistanceKM
      const wsB = wb.Sheets["Bookings_Year1"];
      const rawB = XLSX.utils.sheet_to_json(wsB, { defval: "" });

      bookings = rawB.map(r => {
        const sd = excelDateToJS(r["Startdatum"]);
        const ed = excelDateToJS(r["Einddatum"]);

        const vehId = safeNum(r["Vehicle_ID"]);
        const veh = getVehicleById(vehId);

        const days = safeNum(r["Huurdagen"]);
        const dayPrice = safeNum(r["Dagprijs"]);
        // Prefer provided brut/net if available, else compute
        const bruto = safeNum(r["Bruto omzet"]) || safeNum(r["Bruto_omzet"]) || (days * dayPrice);

        // KM fields (support multiple header names)
        const kmProvided =
          safeNum(r["DistanceKM"]) ||
          safeNum(r["Distance_km"]) ||
          safeNum(r["KM"]) ||
          safeNum(r["Km"]) ||
          safeNum(r["Kilometers"]) ||
          0;

        return ({
          Booking_ID: safeNum(r["Booking_ID"]),
          Vehicle_ID: vehId,
          Startdatum: sd,
          Einddatum: ed,
          Huurdagen: days,
          Dagprijs: dayPrice,
          Bruto: bruto,
          Rating: safeNum(r["Rating"]),
          KM: kmProvided > 0 ? kmProvided : estimateKm(veh, days)
        });
      }).filter(b => b.Booking_ID && b.Vehicle_ID && b.Startdatum);

      document.getElementById("dataStatus").textContent = `Excel geladen: ${file.name}`;
      hydrateFilters(true);
      applyFiltersAndRender();
    }

    // =============================
    // Filters hydration
    // =============================
    function hydrateFilters(setDates=false) {
      const hotspotSel = document.getElementById("hotspotSel");
      const typeSel = document.getElementById("typeSel");
      const vehicleSel = document.getElementById("vehicleSel");

      const hotspots = ["(Alle)"].concat(uniq(vehicles.map(v => v.Hotspot)).sort());
      const types = ["(Alle)"].concat(uniq(vehicles.map(v => (v.Brandstof==="EV" ? "EV" : v.Type))).sort());
      const vehicleOptions = ["(Alle)"].concat(vehicles
        .slice()
        .sort((a,b)=>a.Vehicle_ID-b.Vehicle_ID)
        .map(v => `${v.Vehicle_ID} – ${v.Merk_Model}`));

      hotspotSel.innerHTML = hotspots.map(v => `<option>${escapeHtml(v)}</option>`).join("");
      typeSel.innerHTML = types.map(v => `<option>${escapeHtml(v)}</option>`).join("");
      vehicleSel.innerHTML = vehicleOptions.map(v => `<option>${escapeHtml(v)}</option>`).join("");

      document.getElementById("statVehicles").textContent = fmtInt(vehicles.length);
      document.getElementById("statRecords").textContent = fmtInt(bookings.length);

      if (bookings.length) {
        const minD = new Date(Math.min(...bookings.map(b=>b.Startdatum.getTime())));
        const maxD = new Date(Math.max(...bookings.map(b=>b.Startdatum.getTime())));

        if (setDates || !document.getElementById("fromDate").value) {
          document.getElementById("fromDate").value = toISODate(minD);
          document.getElementById("toDate").value = toISODate(maxD);
        }
      }
    }

    // =============================
    // Apply filters + compute derived fields (fee/net/result)
    // =============================
    function applyFiltersAndRender() {
      if (!vehicles.length || !bookings.length) {
        showAlert("Laad demo-data of upload Excel. Vereiste sheets: Vehicles + Bookings_Year1.");
        return;
      }
      hideAlert();

      const from = document.getElementById("fromDate").value ? new Date(document.getElementById("fromDate").value) : null;
      const to = document.getElementById("toDate").value ? new Date(document.getElementById("toDate").value) : null;
      if (to) to.setHours(23,59,59,999);

      const hotspot = document.getElementById("hotspotSel").value;
      const type = document.getElementById("typeSel").value;
      const vehicle = document.getElementById("vehicleSel").value;
      const minRating = Number(document.getElementById("minRatingSel").value || 0);
      const minDays = Number(document.getElementById("minDaysSel").value || 0);
      const q = document.getElementById("searchInput").value.trim().toLowerCase();

      const feePct = Number(document.getElementById("feePct").value || 0) / 100;
      const varPerDay = Number(document.getElementById("varPerDay").value || 0);
      const fixedPerVeh = Number(document.getElementById("fixedPerVeh").value || 0);

      const vehicleIdFilter = (vehicle && vehicle !== "(Alle)") ? Number(vehicle.split("–")[0].trim()) : null;

      filtered = bookings
        .map(b => {
          const v = getVehicleById(b.Vehicle_ID);
          const vType = v ? (v.Brandstof==="EV" ? "EV" : v.Type) : "—";
          const vHotspot = v ? v.Hotspot : "—";
          const fee = b.Bruto * feePct;
          const netto = b.Bruto - fee;
          const varCost = b.Huurdagen * varPerDay;
          // fixed cost allocated later at period level; store per booking only var costs
          return {
            ...b,
            Type: vType,
            Hotspot: vHotspot,
            Merk_Model: v?.Merk_Model || "",
            Fee: fee,
            Netto: netto,
            VarCost: varCost,
            // Result without fixed allocation
            ResultBeforeFixed: netto - varCost
          };
        })
        .filter(b => {
          if (from && b.Startdatum < from) return false;
          if (to && b.Startdatum > to) return false;

          if (hotspot !== "(Alle)" && b.Hotspot !== hotspot) return false;
          if (type !== "(Alle)" && b.Type !== type) return false;
          if (vehicleIdFilter && b.Vehicle_ID !== vehicleIdFilter) return false;

          if (minDays && b.Huurdagen < minDays) return false;
          if (minRating && b.Rating < minRating) return false;

          if (q) {
            const hay = `${b.Booking_ID} ${b.Vehicle_ID} ${b.Type} ${b.Hotspot} ${b.Merk_Model}`.toLowerCase();
            if (!hay.includes(q)) return false;
          }
          return true;
        });

      // Sort based on dropdown
      const sortSel = document.getElementById("sortSel").value;
      const sorters = {
        start_desc: (a,b)=> b.Startdatum - a.Startdatum,
        start_asc: (a,b)=> a.Startdatum - b.Startdatum,
        netto_desc: (a,b)=> b.Netto - a.Netto,
        netto_asc: (a,b)=> a.Netto - b.Netto,
        days_desc: (a,b)=> b.Huurdagen - a.Huurdagen,
        rating_desc: (a,b)=> b.Rating - a.Rating
      };
      filtered.sort(sorters[sortSel] || sorters.start_desc);

      // KPIs
      const totalBookings = filtered.length;
      const bruto = filtered.reduce((s,b)=>s + b.Bruto, 0);
      const feeSum = filtered.reduce((s,b)=>s + b.Fee, 0);
      const netto = filtered.reduce((s,b)=>s + b.Netto, 0);
      const days = filtered.reduce((s,b)=>s + b.Huurdagen, 0);
      const km = filtered.reduce((s,b)=>s + (b.KM||0), 0);
      const varCost = filtered.reduce((s,b)=>s + b.VarCost, 0);

      // Fixed allocation based on months in period and unique vehicles in scope
      const uniqueVeh = uniq(filtered.map(b=>b.Vehicle_ID));
      const monthSpan = estimateMonthSpan(from, to);
      const fixedCost = uniqueVeh.length * fixedPerVeh * monthSpan;

      const result = netto - varCost - fixedCost;

      const ratingVals = filtered.map(b=>b.Rating).filter(x=>x>0);
      const avgRating = ratingVals.length ? (ratingVals.reduce((s,x)=>s+x,0)/ratingVals.length) : null;
      const avgDays = totalBookings ? (days/totalBookings) : null;
      const kmPerBooking = totalBookings ? (km/totalBookings) : null;

      document.getElementById("kpiBookings").textContent = fmtInt(totalBookings);
      document.getElementById("kpiBookingsSub").textContent = totalBookings ? `≈ ${fmt1(totalBookings / Math.max(1, monthSpan))} boekingen / maand (in selectie)` : "—";

      document.getElementById("kpiDays").textContent = fmtInt(days);
      document.getElementById("kpiDaysSub").textContent = avgDays ? `Gemiddeld ${fmt1(avgDays)} dagen / boeking` : "—";

      document.getElementById("kpiKm").textContent = fmt0(km);
      document.getElementById("kpiKmSub").textContent = kmPerBooking ? `≈ ${fmt0(kmPerBooking)} km / boeking` : "—";

      document.getElementById("kpiBruto").textContent = fmtEUR(bruto);
      document.getElementById("kpiNetto").textContent = fmtEUR(netto);
      document.getElementById("kpiFee").textContent = `Fees (incl. verwerking) ~ ${fmtEUR(feeSum)} (${fmt1((feeSum/Math.max(1,bruto))*100)}%)`;

      document.getElementById("kpiResult").textContent = fmtEUR(result);
      document.getElementById("kpiResultSub").textContent = `Kosten: var ${fmtEUR(varCost)} + vast ${fmtEUR(fixedCost)} (allocatie)`;

      document.getElementById("kpiRating").textContent = avgRating ? fmt1(avgRating) : "—";
      document.getElementById("kpiAvgDays").textContent = avgDays ? fmt1(avgDays) : "—";
      document.getElementById("kpiKmPerBooking").textContent = kmPerBooking ? fmt0(kmPerBooking) : "—";
      document.getElementById("kpiKmPerMonth").textContent = monthSpan ? fmt0(km / Math.max(1, monthSpan)) : "—";

      document.getElementById("kpiVarCost").textContent = fmtEUR(varCost);
      document.getElementById("kpiFixedCost").textContent = fmtEUR(fixedCost);

      // Render charts
      renderTimeChart(fixedPerVeh, monthSpan, uniqueVeh.length);
      renderTypeChart();
      renderHotspotsChart();
      renderVehiclesChart();

      // Render combo table
      renderComboTable(fixedPerVeh, monthSpan);

      // Table data: include per-row allocated fixed? We'll allocate fixed per booking proportional to huurdagen
      const fixedPerDay = (monthSpan>0 && uniqueVeh.length>0) ? (fixedCost / Math.max(1, days)) : 0;
      filteredForTable = filtered.map(b => {
        const fixedAlloc = b.Huurdagen * fixedPerDay;
        const res = b.Netto - b.VarCost - fixedAlloc;
        return { ...b, FixedAlloc: fixedAlloc, Resultaat: res };
      });

      // Default table sort
      applyTableSort();
      renderTable();
    }

    function estimateMonthSpan(from, to) {
      // If missing dates, assume 12 months range (demo) but keep safe
      const a = from ? new Date(from) : new Date(Math.min(...bookings.map(b=>b.Startdatum.getTime())));
      const b = to ? new Date(to) : new Date(Math.max(...bookings.map(b=>b.Startdatum.getTime())));
      const months = (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth()) + 1;
      return Math.max(1, months);
    }

    // =============================
    // Charts
    // =============================
    function ensureDestroy(key) {
      if (charts[key]) { charts[key].destroy(); charts[key]=null; }
    }

    function periodKey(d, gran) {
      if (gran === "week") {
        const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum = tmp.getUTCDay() || 7;
        tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
        const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
        return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
      }
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    function renderTimeChart(fixedPerVeh, monthSpan, vehCount) {
      const gran = document.getElementById("granularitySel").value;

      const sumsNetto = new Map();
      const sumsResult = new Map();
      const counts = new Map();

      // compute fixed allocation per period: fixedPerVeh * vehiclesInScope
      const periodFixed = new Map(); // k -> fixed
      for (const b of filtered) {
        const k = periodKey(b.Startdatum, gran);
        sumsNetto.set(k, (sumsNetto.get(k)||0) + b.Netto);
        counts.set(k, (counts.get(k)||0) + 1);
        // fixed is per month; for week we approximate using monthSpan distribution
        if (!periodFixed.has(k)) periodFixed.set(k, 0);
      }

      // variable costs per period
      const sumsVar = new Map();
      for (const b of filtered) {
        const k = periodKey(b.Startdatum, gran);
        sumsVar.set(k, (sumsVar.get(k)||0) + b.VarCost);
      }

      const labels = Array.from(sumsNetto.keys()).sort();
      // fixed allocation: for month just fixedPerVeh * vehicles that appear in that period; for week approximate as (month fixed / 4.345)
      if (gran === "month") {
        for (const k of labels) {
          // vehicles active in that month in filtered set
          const ids = new Set(filtered.filter(x => periodKey(x.Startdatum, gran)===k).map(x=>x.Vehicle_ID));
          periodFixed.set(k, ids.size * fixedPerVeh);
        }
      } else {
        const weeklyFactor = 4.345; // weeks per month
        for (const k of labels) {
          const ids = new Set(filtered.filter(x => periodKey(x.Startdatum, gran)===k).map(x=>x.Vehicle_ID));
          periodFixed.set(k, (ids.size * fixedPerVeh) / weeklyFactor);
        }
      }

      for (const k of labels) {
        const net = sumsNetto.get(k)||0;
        const vc = sumsVar.get(k)||0;
        const fc = periodFixed.get(k)||0;
        sumsResult.set(k, net - vc - fc);
      }

      const dataNetto = labels.map(l => sumsNetto.get(l)||0);
      const dataResult = labels.map(l => sumsResult.get(l)||0);
      const dataCount = labels.map(l => counts.get(l)||0);

      ensureDestroy("time");
      charts.time = new Chart(document.getElementById("chartTime"), {
        data: {
          labels,
          datasets: [
            { type:'bar', label:'Netto omzet', data:dataNetto, yAxisID:'y' },
            { type:'bar', label:'Resultaat', data:dataResult, yAxisID:'y' },
            { type:'line', label:'Boekingen', data:dataCount, yAxisID:'y2', tension:0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position:'top' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  if (ctx.dataset.label === "Boekingen") return `Boekingen: ${fmtInt(ctx.parsed.y)}`;
                  return `${ctx.dataset.label}: ${fmtEUR(ctx.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            y: { ticks: { callback: (v)=> fmtEUR(v) } },
            y2: { position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=> fmtInt(v) } }
          }
        }
      });
    }

    function renderTypeChart() {
      const m = new Map(); // type -> {netto, count}
      for (const b of filtered) {
        const k = b.Type || "Onbekend";
        if (!m.has(k)) m.set(k, {netto:0, count:0});
        const o = m.get(k);
        o.netto += b.Netto;
        o.count += 1;
      }
      const rows = Array.from(m.entries()).sort((a,b)=> b[1].netto - a[1].netto);
      const labels = rows.map(r=>r[0]);
      const netto = rows.map(r=>r[1].netto);
      const count = rows.map(r=>r[1].count);

      ensureDestroy("type");
      charts.type = new Chart(document.getElementById("chartType"), {
        data: {
          labels,
          datasets: [
            { type:'doughnut', label:'Netto omzet', data: netto },
            { type:'bar', label:'Boekingen', data: count, yAxisID:'y2' }
          ]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label === "Boekingen"
                  ? `Boekingen: ${fmtInt(ctx.parsed.y || ctx.parsed)}`
                  : `Netto: ${fmtEUR(ctx.parsed)}`
              }
            },
            legend: { position:'bottom' }
          },
          scales: {
            y2: { display:false }
          }
        }
      });
    }

    function renderHotspotsChart() {
      const m = new Map(); // hotspot -> {netto, count}
      for (const b of filtered) {
        const k = b.Hotspot || "Onbekend";
        if (!m.has(k)) m.set(k, {netto:0, count:0});
        const o = m.get(k);
        o.netto += b.Netto;
        o.count += 1;
      }
      const rows = Array.from(m.entries()).sort((a,b)=> b[1].netto - a[1].netto).slice(0,10);

      ensureDestroy("hotspots");
      charts.hotspots = new Chart(document.getElementById("chartHotspots"), {
        data: {
          labels: rows.map(r=>r[0]),
          datasets: [
            { type:'bar', label:'Netto omzet', data: rows.map(r=>r[1].netto), yAxisID:'y' },
            { type:'line', label:'Boekingen', data: rows.map(r=>r[1].count), yAxisID:'y2', tension:0.25 }
          ]
        },
        options: {
          indexAxis:'y',
          plugins: {
            legend: { position:'top' },
            tooltip: {
              callbacks: {
                label: (ctx)=> ctx.dataset.label==="Boekingen"
                  ? `Boekingen: ${fmtInt(ctx.parsed.x)}`
                  : `Netto: ${fmtEUR(ctx.parsed.x)}`
              }
            }
          },
          scales: {
            y: { ticks:{ callback:(v)=> v } },
            x: { ticks:{ callback:(v)=> fmtEUR(v) } },
            y2: { position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=> fmtInt(v) } }
          }
        }
      });
    }

    function renderVehiclesChart() {
      const m = new Map(); // vid -> {netto, count}
      for (const b of filtered) {
        const k = b.Vehicle_ID;
        if (!m.has(k)) m.set(k, {netto:0, count:0});
        const o = m.get(k);
        o.netto += b.Netto;
        o.count += 1;
      }
      const rows = Array.from(m.entries())
        .map(([vid, obj]) => {
          const v = getVehicleById(vid);
          return [`${vid} – ${v?.Merk_Model || ""}`.trim(), obj.netto, obj.count];
        })
        .sort((a,b)=> b[1]-a[1])
        .slice(0,10);

      ensureDestroy("vehicles");
      charts.vehicles = new Chart(document.getElementById("chartVehicles"), {
        data: {
          labels: rows.map(r=>r[0]),
          datasets: [
            { type:'bar', label:'Netto omzet', data: rows.map(r=>r[1]), yAxisID:'y' },
            { type:'line', label:'Boekingen', data: rows.map(r=>r[2]), yAxisID:'y2', tension:0.25 }
          ]
        },
        options: {
          plugins: {
            legend: { position:'top' },
            tooltip: {
              callbacks: {
                label: (ctx)=> ctx.dataset.label==="Boekingen"
                  ? `Boekingen: ${fmtInt(ctx.parsed.y)}`
                  : `Netto: ${fmtEUR(ctx.parsed.y)}`
              }
            }
          },
          scales: {
            y: { ticks:{ callback:(v)=> fmtEUR(v) } },
            y2: { position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:(v)=> fmtInt(v) } }
          }
        }
      });
    }

    // =============================
    // Combo table (hotspot x vehicle)
    // =============================
    function renderComboTable(fixedPerVeh, monthSpan) {
      const tbody = document.getElementById("comboTbody");
      const agg = new Map();

      // fixed allocation per booking day basis (similar to table logic)
      const totalDays = filtered.reduce((s,b)=>s + b.Huurdagen, 0);
      const uniqueVeh = uniq(filtered.map(b=>b.Vehicle_ID));
      const fixedCost = uniqueVeh.length * fixedPerVeh * monthSpan;
      const fixedPerDay = totalDays ? (fixedCost / totalDays) : 0;

      for (const b of filtered) {
        const v = getVehicleById(b.Vehicle_ID);
        const combi = `${b.Hotspot} • ${b.Vehicle_ID} – ${v?.Merk_Model || ""}`.trim();
        if (!agg.has(combi)) agg.set(combi, {count:0, days:0, km:0, netto:0, res:0});
        const o = agg.get(combi);
        o.count += 1;
        o.days += b.Huurdagen;
        o.km += (b.KM||0);
        o.netto += b.Netto;
        const res = b.Netto - b.VarCost - (b.Huurdagen * fixedPerDay);
        o.res += res;
      }

      const rows = Array.from(agg.entries())
        .map(([k, o]) => [k, o.count, o.days, o.km, o.netto, o.res])
        .sort((a,b)=> b[5]-a[5])
        .slice(0, 12);

      tbody.innerHTML = rows.map(r => `
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-3 font-semibold text-slate-800">${escapeHtml(r[0])}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(fmtInt(r[1]))}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(fmtInt(r[2]))}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(fmt0(r[3]))}</td>
          <td class="px-3 py-3 text-right mono font-semibold">${escapeHtml(fmtEUR(r[4]))}</td>
          <td class="px-3 py-3 text-right mono font-semibold">${escapeHtml(fmtEUR(r[5]))}</td>
        </tr>
      `).join("");
    }

    // =============================
    // Table: sorting + rendering
    // =============================
    function applyTableSort() {
      const key = tableSort.key;
      const dir = tableSort.dir;

      const getVal = (b) => {
        if (key === "Booking_ID") return b.Booking_ID;
        if (key === "Vehicle_ID") return b.Vehicle_ID;
        if (key === "Type") return b.Type;
        if (key === "Hotspot") return b.Hotspot;
        if (key === "Startdatum") return b.Startdatum?.getTime?.() || 0;
        if (key === "Einddatum") return b.Einddatum?.getTime?.() || 0;
        if (key === "Huurdagen") return b.Huurdagen;
        if (key === "KM") return b.KM || 0;
        if (key === "Netto") return b.Netto;
        if (key === "Resultaat") return b.Resultaat;
        if (key === "Rating") return b.Rating;
        return 0;
      };

      filteredForTable.sort((a,b) => {
        const av = getVal(a);
        const bv = getVal(b);
        if (typeof av === "string") {
          return dir === "asc" ? av.localeCompare(bv) : bv.localeCompare(av);
        }
        return dir === "asc" ? (av - bv) : (bv - av);
      });
    }

    function renderTable() {
      const tbody = document.getElementById("bookingsTbody");
      const limit = Number(document.getElementById("limitSel").value || 100);
      const rows = filteredForTable.slice(0, limit);

      tbody.innerHTML = rows.map(b => `
        <tr class="hover:bg-slate-50 cursor-pointer" data-id="${b.Booking_ID}">
          <td class="px-3 py-3 font-semibold text-slate-800">${escapeHtml(String(b.Booking_ID))}</td>
          <td class="px-3 py-3 text-slate-700">${escapeHtml(String(b.Vehicle_ID))}</td>
          <td class="px-3 py-3">${escapeHtml(String(b.Type||"—"))}</td>
          <td class="px-3 py-3">${escapeHtml(String(b.Hotspot||"—"))}</td>
          <td class="px-3 py-3">${escapeHtml(toISODate(b.Startdatum)||"—")}</td>
          <td class="px-3 py-3">${escapeHtml(toISODate(b.Einddatum)||"—")}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(String(b.Huurdagen))}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(fmt0(b.KM||0))}</td>
          <td class="px-3 py-3 text-right mono font-semibold">${escapeHtml(fmtEUR(b.Netto))}</td>
          <td class="px-3 py-3 text-right mono font-semibold">${escapeHtml(fmtEUR(b.Resultaat))}</td>
          <td class="px-3 py-3 text-right mono">${escapeHtml(fmt1(b.Rating))}</td>
        </tr>
      `).join("");

      [...tbody.querySelectorAll("tr")].forEach(tr => {
        tr.addEventListener("click", () => {
          const id = Number(tr.getAttribute("data-id"));
          const b = filteredForTable.find(x=>x.Booking_ID===id);
          if (b) openModal(b);
        });
      });
    }

    // =============================
    // Modal
    // =============================
    function openModal(b) {
      const v = getVehicleById(b.Vehicle_ID);
      const fields = [
        ["Booking_ID", b.Booking_ID],
        ["Vehicle_ID", b.Vehicle_ID],
        ["Merk/Model", v?.Merk_Model || "—"],
        ["Type", b.Type || "—"],
        ["Hotspot", b.Hotspot || "—"],
        ["Start", toISODate(b.Startdatum)],
        ["Eind", toISODate(b.Einddatum)],
        ["Huurdagen", b.Huurdagen],
        ["KM", fmt0(b.KM||0)],
        ["Bruto omzet", fmtEUR(b.Bruto)],
        ["Fees (platform+verwerking)", fmtEUR(b.Fee)],
        ["Netto omzet", fmtEUR(b.Netto)],
        ["Variabele kosten", fmtEUR(b.VarCost)],
        ["Vast allocatie (booking)", fmtEUR(b.FixedAlloc)],
        ["Resultaat (booking)", fmtEUR(b.Resultaat)],
        ["Rating", fmt1(b.Rating)]
      ];
      document.getElementById("modalSub").textContent =
        `Voertuig ${b.Vehicle_ID}${v ? " – "+v.Merk_Model : ""} • ${b.Hotspot || ""}`;

      document.getElementById("modalBody").innerHTML = fields.map(([k,val]) => `
        <div class="rounded-2xl border border-slate-200 bg-white p-3">
          <div class="text-xs text-slate-500">${escapeHtml(String(k))}</div>
          <div class="mono mt-1 text-sm font-extrabold text-slate-900">${escapeHtml(String(val ?? "—"))}</div>
        </div>
      `).join("");

      document.getElementById("modal").classList.remove("hidden");
    }
    function closeModal() { document.getElementById("modal").classList.add("hidden"); }

    // =============================
    // Export CSV
    // =============================
    function exportFilteredCsv() {
      if (!filteredForTable.length) return;

      const rows = filteredForTable.map(b => {
        const v = getVehicleById(b.Vehicle_ID) || {};
        return {
          Booking_ID: b.Booking_ID,
          Vehicle_ID: b.Vehicle_ID,
          Type: b.Type,
          Hotspot: b.Hotspot,
          Merk_Model: v.Merk_Model || "",
          Startdatum: toISODate(b.Startdatum),
          Einddatum: toISODate(b.Einddatum),
          Huurdagen: b.Huurdagen,
          KM: b.KM || 0,
          Dagprijs: b.Dagprijs,
          Bruto_omzet: b.Bruto,
          Fees: b.Fee,
          Netto_omzet: b.Netto,
          Var_cost: b.VarCost,
          Fixed_alloc: b.FixedAlloc,
          Resultaat: b.Resultaat,
          Rating: b.Rating
        };
      });

      const header = Object.keys(rows[0]);
      const csv = [
        header.join(","),
        ...rows.map(r => header.map(h => {
          const val = r[h];
          const s = (val===null || val===undefined) ? "" : String(val);
          return `"${s.replaceAll('"','""')}"`;
        }).join(","))
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "keylessgo_snappcar_bookings_filtered_v2.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =============================
    // Presets + events
    // =============================
    function setPresetDays(days) {
      const to = new Date(document.getElementById("toDate").value || new Date());
      const from = new Date(to);
      from.setDate(to.getDate() - (days-1));
      document.getElementById("fromDate").value = toISODate(from);
      applyFiltersAndRender();
    }
    function setPresetYTD() {
      const to = new Date(document.getElementById("toDate").value || new Date());
      const from = new Date(to.getFullYear(), 0, 1);
      document.getElementById("fromDate").value = toISODate(from);
      applyFiltersAndRender();
    }

    document.getElementById("btnUseDemo").addEventListener("click", loadDemo);
    document.getElementById("fileInput").addEventListener("change", (e) => handleFile(e.target.files?.[0]));

    document.getElementById("btnPreset30").addEventListener("click", ()=>setPresetDays(30));
    document.getElementById("btnPreset90").addEventListener("click", ()=>setPresetDays(90));
    document.getElementById("btnPresetYTD").addEventListener("click", setPresetYTD);

    document.getElementById("btnReset").addEventListener("click", () => {
      document.getElementById("hotspotSel").value = "(Alle)";
      document.getElementById("typeSel").value = "(Alle)";
      document.getElementById("vehicleSel").value = "(Alle)";
      document.getElementById("minRatingSel").value = "0";
      document.getElementById("minDaysSel").value = "0";
      document.getElementById("searchInput").value = "";
      document.getElementById("sortSel").value = "start_desc";
      applyFiltersAndRender();
    });

    document.getElementById("btnExportCsv").addEventListener("click", exportFilteredCsv);

    ["fromDate","toDate","hotspotSel","typeSel","vehicleSel","minRatingSel","minDaysSel","granularitySel","searchInput","limitSel","sortSel","feePct","varPerDay","fixedPerVeh"].forEach(id => {
      document.getElementById(id).addEventListener("input", applyFiltersAndRender);
      document.getElementById(id).addEventListener("change", applyFiltersAndRender);
    });

    // Table header sort
    document.querySelectorAll("th.sortable").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort");
        if (tableSort.key === key) tableSort.dir = (tableSort.dir === "asc" ? "desc" : "asc");
        else { tableSort.key = key; tableSort.dir = (key==="Startdatum" ? "desc" : "desc"); }
        applyTableSort();
        renderTable();
      });
    });

    document.getElementById("modalClose").addEventListener("click", closeModal);
    document.getElementById("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") closeModal();
    });

    // Kickoff
    document.getElementById("btnUseDemo").classList.remove("hidden");
    loadDemo();
  </script>
</body>
</html>
