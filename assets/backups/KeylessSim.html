<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeylessGo Ultimate Strategy Simulator v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        body { background-color: #0f172a; color: #e2e8f0; }
        
        .panel { background-color: #1e293b; border: 1px solid #334155; }
        .input-group label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: 700; margin-bottom: 2px; display: block; }
        .input-field { background-color: #0f172a; border: 1px solid #334155; color: white; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; transition: border-color 0.2s; }
        .input-field:focus { border-color: #0ea5e9; outline: none; }
        
        .tab-active { border-bottom: 2px solid #0ea5e9; color: #0ea5e9; background: rgba(14, 165, 233, 0.1); }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #94a3b8; background: rgba(255,255,255,0.02); }

        .advice-good { border-left: 3px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .advice-warn { border-left: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .advice-bad { border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <header class="bg-slate-900 border-b border-slate-800 h-14 flex items-center justify-between px-6 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-sky-600 rounded flex items-center justify-center text-white font-bold text-sm">KG</div>
            <div>
                <h1 class="font-bold text-sm tracking-wide text-white leading-tight">KeylessGo Strategy Sim</h1>
                <div class="text-[10px] text-sky-400 font-mono">v5.0 ULTIMATE EDITION</div>
            </div>
        </div>
        <div class="flex gap-6 text-xs font-mono text-slate-400">
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase text-slate-500">Startdatum</span>
                <span id="disp-start-date" class="text-white font-bold">Maart 2026</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase text-slate-500">Horizon</span>
                <span id="disp-horizon" class="text-white font-bold">10 Jaar</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase text-slate-500">Scenario</span>
                <span class="text-sky-400 font-bold">Custom</span>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- SIDEBAR: PARAMETERS -->
        <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto z-10 custom-scrollbar">
            <div class="p-4 space-y-6 pb-20">
                
                <!-- Group 0: Timing -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 border-b border-slate-800 pb-1">üìÖ Tijdlijn & Horizon</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Start Maand</label>
                            <select id="p-start-month" class="input-field w-full" onchange="runModel()">
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2" selected>Maart</option>
                                <option value="5">Juni</option>
                                <option value="8">September</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Start Jaar</label>
                            <input type="number" id="p-start-year" class="input-field w-full" value="2026" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Horizon (Jaren)</label>
                        <input type="range" id="p-horizon" min="3" max="15" value="10" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="runModel()">
                        <div class="text-right text-xs text-slate-400 mt-1" id="val-horizon">10 Jaar</div>
                    </div>
                </div>

                <!-- Group 1: Strategic Assets -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 border-b border-slate-800 pb-1">üöÄ Vloot Strategie</h3>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Start Vloot</label>
                            <input type="number" id="p-fleet-start" class="input-field w-full" value="10" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Groei (Autos/Jaar)</label>
                            <input type="number" id="p-growth" class="input-field w-full" value="4" onchange="runModel()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Mix: Busjes (%)</label>
                        <input type="range" id="p-mix" min="0" max="100" value="70" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="runModel()">
                        <div class="flex justify-between text-xs mt-1">
                            <span class="text-sky-400" id="val-mix">70% Bus</span>
                            <span class="text-slate-500">30% Auto</span>
                        </div>
                    </div>
                </div>

                <!-- Group 2: Unit Economics -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 border-b border-slate-800 pb-1">üí∂ Pricing & Bezetting</h3>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Dagprijs Bus (‚Ç¨)</label>
                            <input type="number" id="p-price-bus" class="input-field w-full" value="85" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Dagprijs Auto (‚Ç¨)</label>
                            <input type="number" id="p-price-car" class="input-field w-full" value="45" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Bezetting (Gemiddeld %)</label>
                        <input type="range" id="p-occ" min="15" max="65" value="38" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="runModel()">
                        <div class="text-right text-xs text-sky-400 mt-1" id="val-occ">38%</div>
                    </div>
                </div>

                <!-- Group 3: Capital & Expenses -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 border-b border-slate-800 pb-1">üí∞ Kapitaal & Kosten</h3>
                    
                    <div class="input-group">
                        <label>Start Investering (‚Ç¨)</label>
                        <input type="number" id="p-capex-start" class="input-field w-full" value="100000" step="10000" onchange="runModel()">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                         <div class="input-group">
                            <label>Extra Inv. (Yr 2)</label>
                            <input type="number" id="p-capex-y2" class="input-field w-full" value="0" step="10000" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Dividend (%)</label>
                            <input type="number" id="p-dividend" class="input-field w-full" value="0" max="100" onchange="runModel()">
                        </div>
                    </div>

                    <div class="input-group mt-2">
                        <label>Marketing (‚Ç¨/Auto/Maand)</label>
                        <input type="number" id="p-marketing" class="input-field w-full" value="25" onchange="runModel()">
                    </div>
                     <div class="input-group">
                        <label>Vaste Overhead (‚Ç¨/Maand)</label>
                        <input type="number" id="p-overhead" class="input-field w-full" value="500" onchange="runModel()">
                    </div>
                </div>

                 <!-- Group 4: Macro -->
                 <div class="space-y-3">
                    <h3 class="text-xs font-bold text-white flex items-center gap-2 border-b border-slate-800 pb-1">üåç Macro</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Inflatie (%)</label>
                            <input type="number" id="p-inf" class="input-field w-full" value="2.5" step="0.1" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>VPB Belasting (%)</label>
                            <input type="number" id="p-tax" class="input-field w-full" value="19" onchange="runModel()">
                        </div>
                    </div>
                </div>

            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-950">
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-800 bg-slate-900/50 px-4">
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-active transition" onclick="switchTab('dashboard', this)">üìä Dashboard & Advies</button>
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-inactive transition" onclick="switchTab('financials', this)">üìë P&L en Balans</button>
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-inactive transition" onclick="switchTab('cash', this)">üíµ Liquiditeit</button>
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-inactive transition" onclick="switchTab('fleet', this)">üöê Vloot Detail</button>
            </div>

            <!-- Views -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
                
                <!-- VIEW 1: DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    <!-- Top KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Cumulatieve Winst</h4>
                            <div class="text-2xl font-mono font-bold text-white mt-1" id="kpi-cum-profit">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-400 mt-1">Na belasting (Einde looptijd)</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Eind Cashpositie</h4>
                            <div class="text-2xl font-mono font-bold text-white mt-1" id="kpi-end-cash">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-400 mt-1">Liquiditeit op balans</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">ROI (Gemiddeld)</h4>
                            <div class="text-2xl font-mono font-bold text-white mt-1" id="kpi-roi">0%</div>
                            <div class="text-[10px] text-slate-400 mt-1">Return on Investment/Jr</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Solvabiliteit</h4>
                            <div class="text-2xl font-mono font-bold text-white mt-1" id="kpi-solv">0%</div>
                            <div class="text-[10px] text-slate-400 mt-1">Eigen Vermogen / Totaal</div>
                        </div>
                    </div>

                    <!-- Main Chart Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="panel rounded-lg p-5 lg:col-span-2">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Financi√´le Performance (Omzet vs Winst)</h3>
                            <div class="h-64 w-full">
                                <canvas id="chart-main"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5 flex flex-col">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Strategisch AI Advies</h3>
                            <div id="advice-list" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar max-h-64">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: FINANCIAL STATEMENTS -->
                <div id="view-financials" class="hidden space-y-8">
                    
                    <!-- P&L Table -->
                    <div class="panel rounded-lg overflow-hidden">
                        <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold text-xs uppercase">Winst- en Verliesrekening (Geconsolideerd per Jaar)</h3>
                            <span class="text-[10px] text-slate-400">Bedragen in Euro's</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-xs font-mono" id="table-pl">
                                <thead class="bg-slate-900 text-slate-400">
                                    <tr>
                                        <th class="text-left px-4 py-2">Post</th>
                                        <!-- Years headers generated by JS -->
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-slate-300">
                                    <!-- Rows generated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Balance Sheet Visual -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Balans Evolutie (Activa)</h3>
                            <div class="h-64">
                                <canvas id="chart-assets"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Balans Evolutie (Passiva)</h3>
                            <div class="h-64">
                                <canvas id="chart-liabilities"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: CASHFLOW & CAPITAL -->
                <div id="view-cash" class="hidden space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="panel rounded-lg p-5 lg:col-span-2">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Liquiditeitsprognose (Maandelijks Detail)</h3>
                            <p class="text-xs text-slate-500 mb-2">Toont de bankstand aan het einde van elke maand. Let op dips onder nul.</p>
                            <div class="h-72 w-full">
                                <canvas id="chart-cash-monthly"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-white font-bold text-xs uppercase mb-4">Kapitaalstromen</h3>
                            <div class="space-y-4 text-xs">
                                <div class="flex justify-between border-b border-slate-700 pb-2">
                                    <span class="text-slate-400">Totaal Ge√Ønvesteerd</span>
                                    <span class="text-white font-bold" id="summ-invest">‚Ç¨ 0</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-700 pb-2">
                                    <span class="text-slate-400">Totaal Dividend Uitgekeerd</span>
                                    <span class="text-white font-bold" id="summ-div">‚Ç¨ 0</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-700 pb-2">
                                    <span class="text-slate-400">Operationele Cashflow</span>
                                    <span class="text-green-400 font-bold" id="summ-ops-cash">‚Ç¨ 0</span>
                                </div>
                                <div class="p-3 bg-slate-800 rounded border border-slate-700 mt-4">
                                    <strong class="block text-sky-400 mb-1">Advies Kapitaal</strong>
                                    <p class="text-slate-400 leading-relaxed" id="cash-advice">...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 4: FLEET -->
                <div id="view-fleet" class="hidden space-y-6">
                    <div class="panel rounded-lg p-5">
                        <h3 class="text-white font-bold text-xs uppercase mb-4">Vloot Cohort Analyse</h3>
                        <div class="h-64 w-full">
                            <canvas id="chart-cohorts"></canvas>
                        </div>
                    </div>
                    <div class="panel rounded-lg overflow-hidden">
                         <div class="overflow-x-auto">
                            <table class="w-full text-right text-xs font-mono" id="table-fleet">
                                <thead class="bg-slate-900 text-slate-400">
                                    <tr>
                                        <th class="text-left px-4 py-2">Jaar</th>
                                        <th>Totaal Vloot</th>
                                        <th>In Lease</th>
                                        <th>Eigendom</th>
                                        <th>Boekwaarde Activa</th>
                                        <th>Lease Schuld (Rest)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-slate-300" id="body-fleet">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- SIMULATION ENGINE -->
    <script>
        // --- GLOBAL CHART INSTANCES ---
        let charts = {};

        // --- UTILS ---
        const fmtMoney = (val) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
        const fmtPct = (val) => new Intl.NumberFormat('nl-NL', { style: 'percent', minimumFractionDigits: 1 }).format(val);

        function switchTab(viewId, btn) {
            ['dashboard', 'financials', 'cash', 'fleet'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+viewId).classList.remove('hidden');
            document.querySelectorAll('button').forEach(b => {
                if(b.classList.contains('tab-active')) {
                    b.classList.remove('tab-active');
                    b.classList.add('tab-inactive');
                }
            });
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
        }

        // --- MAIN SIMULATION LOGIC ---
        function runModel() {
            // 1. GET INPUTS
            const startMonth = parseInt(document.getElementById('p-start-month').value);
            const startYear = parseInt(document.getElementById('p-start-year').value);
            const horizonYears = parseInt(document.getElementById('p-horizon').value);
            
            // Updates Display
            const monthNames = ["Jan", "Feb", "Mrt", "Apr", "Mei", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"];
            document.getElementById('disp-start-date').innerText = `${monthNames[startMonth]} ${startYear}`;
            document.getElementById('disp-horizon').innerText = `${horizonYears} Jaar`;
            document.getElementById('val-horizon').innerText = `${horizonYears} Jaar`;
            document.getElementById('val-occ').innerText = document.getElementById('p-occ').value + "%";
            const mixVal = document.getElementById('p-mix').value;
            document.getElementById('val-mix').innerText = `${mixVal}% Bus`;

            // Operational Inputs
            const fleetStart = parseInt(document.getElementById('p-fleet-start').value);
            const growthRate = parseInt(document.getElementById('p-growth').value); // absolute number growth per year
            const mixBusPct = parseInt(document.getElementById('p-mix').value) / 100;
            const priceBus = parseInt(document.getElementById('p-price-bus').value);
            const priceCar = parseInt(document.getElementById('p-price-car').value);
            const occBase = parseInt(document.getElementById('p-occ').value) / 100;
            
            // Costs
            const feePct = 0.30; // SnappCar
            const capexStart = parseInt(document.getElementById('p-capex-start').value);
            const capexY2 = parseInt(document.getElementById('p-capex-y2').value);
            const dividendPct = parseInt(document.getElementById('p-dividend').value) / 100;
            const mktPerCar = parseInt(document.getElementById('p-marketing').value);
            const overhead = parseInt(document.getElementById('p-overhead').value);
            const inflation = parseFloat(document.getElementById('p-inf').value) / 100;
            const taxRate = parseFloat(document.getElementById('p-tax').value) / 100;

            // Unit Economics Assumptions
            const ASSET_VAL_BUS = 35000; 
            const ASSET_VAL_CAR = 20000;
            const LEASE_PM_BUS = 450;
            const LEASE_PM_CAR = 255;
            const OPS_BASE_BUS = 80;
            const OPS_BASE_CAR = 60;
            const INS_HARDWARE = 48; // Fixed ops

            // --- SIMULATION ARRAYS (MONTHLY RESOLUTION) ---
            const totalMonths = horizonYears * 12;
            const monthlyData = [];
            
            // State Variables
            let currentFleet = fleetStart;
            let cash = capexStart;
            let equity = capexStart; // Startkapitaal
            let retainedEarnings = 0;
            
            // Fleet Cohorts: { type, monthAcquired, cost, paidOffMonth }
            let cohorts = [];
            
            // Init Start Fleet (Acquired at month 0)
            const busesStart = Math.round(fleetStart * mixBusPct);
            for(let k=0; k<busesStart; k++) cohorts.push({ type: 'bus', mAcq: 0, cost: ASSET_VAL_BUS, leaseEnd: 60 });
            for(let k=0; k<fleetStart-busesStart; k++) cohorts.push({ type: 'car', mAcq: 0, cost: ASSET_VAL_CAR, leaseEnd: 60 });

            let totalInvested = capexStart;
            let totalDividends = 0;

            // --- MONTHLY LOOP ---
            for (let m = 0; m < totalMonths; m++) {
                // Time tracking
                const currentCalMonth = (startMonth + m) % 12;
                const currentCalYear = startYear + Math.floor((startMonth + m) / 12);
                const yearIndex = Math.floor(m / 12);

                // 1. Growth (Add vehicles in Jan of each year after start)
                if (m > 0 && currentCalMonth === 0 && yearIndex < horizonYears) {
                    const newBuses = Math.round(growthRate * mixBusPct);
                    const newCars = growthRate - newBuses;
                    for(let k=0; k<newBuses; k++) cohorts.push({ type: 'bus', mAcq: m, cost: ASSET_VAL_BUS, leaseEnd: m + 60 });
                    for(let k=0; k<newCars; k++) cohorts.push({ type: 'car', mAcq: m, cost: ASSET_VAL_CAR, leaseEnd: m + 60 });
                    currentFleet += growthRate;
                }

                // 2. Extra Investment (Year 2 start)
                if (m === 12 && capexY2 > 0) {
                    cash += capexY2;
                    equity += capexY2;
                    totalInvested += capexY2;
                }

                // 3. Operational Calcs
                // Inflation factor
                const inflator = Math.pow(1 + inflation, yearIndex);
                
                // Revenue
                let mRev = 0;
                let mLeaseCost = 0;
                let mOpsCost = 0;
                let bookValueTotal = 0;
                let leaseLiabilityTotal = 0;
                let activeLeaseCount = 0;

                cohorts.forEach(c => {
                    // Revenue
                    const price = c.type === 'bus' ? priceBus : priceCar;
                    // Occupancy ramp up for new vehicles (simple logic: first 3 months 50% performance)
                    const ramp = (m - c.mAcq) < 3 ? 0.7 : 1.0;
                    const days = 30.5;
                    mRev += price * inflator * days * occBase * ramp;

                    // Lease Cost (if active)
                    if (m < c.leaseEnd) {
                        mLeaseCost += c.type === 'bus' ? LEASE_PM_BUS : LEASE_PM_CAR;
                        activeLeaseCount++;
                        
                        // Liability (Approx: Remaining payments)
                        const remainingMonths = c.leaseEnd - m;
                        leaseLiabilityTotal += remainingMonths * (c.type === 'bus' ? LEASE_PM_BUS : LEASE_PM_CAR); 
                    }

                    // Ops Cost
                    const baseOps = c.type === 'bus' ? OPS_BASE_BUS : OPS_BASE_CAR;
                    // Maintenance increases with age (after 5 years)
                    const ageMonths = m - c.mAcq;
                    const ageFactor = ageMonths > 60 ? 1.5 : 1.0;
                    mOpsCost += (baseOps * ageFactor * inflator) + INS_HARDWARE;

                    // Depreciation (Linear 60 months to 20% residual)
                    const residual = c.cost * 0.20;
                    const deprPerMonth = (c.cost - residual) / 60;
                    let currentVal = c.cost - (Math.min(ageMonths, 60) * deprPerMonth);
                    bookValueTotal += currentVal;
                });

                // General Ops
                const fee = mRev * feePct;
                const marketing = currentFleet * mktPerCar * inflator;
                const fixedOverhead = overhead * inflator;
                
                // P&L Structure
                const grossProfit = mRev - fee;
                const opex = mOpsCost + marketing + fixedOverhead;
                // Treat Lease as Opex for Cashflow/EBITDA, but for accounting strictness:
                // Simple View: EBITDA = Gross - Opex. 
                // Net Profit = EBITDA - Lease - Tax. (Assuming lease covers depreciation+interest).
                
                const ebitda = grossProfit - opex;
                const ebit = ebitda - mLeaseCost; // Simplified: Lease is the major cost
                
                let tax = 0;
                if (ebit > 0) tax = ebit * taxRate;
                const netProfit = ebit - tax;

                // Cashflow
                cash += netProfit; // Add profit
                // (Note: Depreciation is non-cash, but Lease payment IS cash. Since we subtracted Lease in Net Profit, cash is roughly correct. 
                // Technically we should add back depreciation and subtract principal repayment, but financial lease payment ~= both).

                // Dividends (Paid annually in Dec)
                let divPaid = 0;
                if (currentCalMonth === 11 && netProfit > 0 && retainedEarnings + netProfit > 0) {
                     // Check annual profit logic ideally, but let's base on current month trigger for sim simplicity
                     // Better: Base on accumulated retained earnings positive
                     const distributable = Math.max(0, cash - 20000); // Keep 20k buffer
                     const divAmount = Math.min(distributable, (netProfit * 12) * dividendPct); // Crude annual approx
                     if (divAmount > 0) {
                         cash -= divAmount;
                         divPaid = divAmount;
                         totalDividends += divAmount;
                     }
                }
                
                retainedEarnings += (netProfit - divPaid);

                // Balance Sheet Logic
                // Assets = Cash + Vehicles(Book)
                // Liab = Lease Debt
                // Equity = Assets - Liab
                const totalAssets = cash + bookValueTotal;
                const calculatedEquity = totalAssets - leaseLiabilityTotal;

                monthlyData.push({
                    monthIndex: m,
                    yearLabel: currentCalYear,
                    rev: mRev,
                    fee: fee,
                    lease: mLeaseCost,
                    opex: opex,
                    tax: tax,
                    net: netProfit,
                    cash: cash,
                    assets: totalAssets,
                    liab: leaseLiabilityTotal,
                    equity: calculatedEquity,
                    fleet: currentFleet,
                    activeLease: activeLeaseCount,
                    bookValue: bookValueTotal
                });
            }

            // --- AGGREGATION FOR UI ---
            // Group by Year for Tables
            const yearlyData = [];
            let yTemp = { rev:0, fee:0, lease:0, opex:0, net:0, cashEnd:0 };
            
            monthlyData.forEach((d, i) => {
                yTemp.rev += d.rev;
                yTemp.fee += d.fee;
                yTemp.lease += d.lease;
                yTemp.opex += d.opex;
                yTemp.net += d.net;
                
                // End of year or end of sim
                if ((i+1) % 12 === 0 || i === monthlyData.length -1) {
                    yearlyData.push({
                        year: d.yearLabel,
                        rev: yTemp.rev,
                        fee: yTemp.fee,
                        lease: yTemp.lease,
                        opex: yTemp.opex,
                        net: yTemp.net,
                        cashEnd: d.cash, // Snapshots
                        assets: d.assets,
                        liab: d.liab,
                        fleet: d.fleet,
                        leased: d.activeLease,
                        book: d.bookValue
                    });
                    yTemp = { rev:0, fee:0, lease:0, opex:0, net:0 };
                }
            });

            // --- RENDER FUNCTIONS ---
            updateKPIs(monthlyData, yearlyData, totalInvested);
            renderCharts(monthlyData, yearlyData);
            renderPLTable(yearlyData);
            renderFleetTable(yearlyData);
            renderCashSummary(totalInvested, totalDividends, yearlyData);
            generateAdvice(monthlyData, yearlyData, mixBusPct);
        }

        // --- RENDER UI COMPONENTS ---
        
        function updateKPIs(m, y, invested) {
            const final = y[y.length-1];
            const cumProfit = y.reduce((a,b) => a + b.net, 0);
            
            document.getElementById('kpi-cum-profit').innerText = fmtMoney(cumProfit);
            document.getElementById('kpi-end-cash').innerText = fmtMoney(final.cashEnd);
            
            const avgAnnualProfit = cumProfit / y.length;
            const roi = (avgAnnualProfit / invested) * 100;
            document.getElementById('kpi-roi').innerText = roi.toFixed(1) + "%";
            
            const solv = ((final.assets - final.liab) / final.assets) * 100;
            document.getElementById('kpi-solv').innerText = solv.toFixed(1) + "%";
            
            // Color coding
            document.getElementById('kpi-end-cash').className = final.cashEnd < 0 ? "text-2xl font-mono font-bold text-red-500 mt-1" : "text-2xl font-mono font-bold text-white mt-1";
        }

        function renderCharts(m, y) {
            const labels = y.map(d => d.year);
            const mLabels = m.filter((_, i) => i%3===0).map(d => `M${d.monthIndex+1}`); // Sparse labels

            // 1. Main Financials (Rev vs Profit)
            updateChart('chart-main', 'bar', {
                labels: labels,
                datasets: [
                    { label: 'Omzet', data: y.map(d=>d.rev), backgroundColor: '#3b82f6' },
                    { label: 'Netto Winst', data: y.map(d=>d.net), type: 'line', borderColor: '#10b981', borderWidth: 3, pointBackgroundColor: '#fff' }
                ]
            });

            // 2. Assets (Stacked)
            updateChart('chart-assets', 'bar', {
                labels: labels,
                datasets: [
                    { label: 'Liquiditeit (Cash)', data: y.map(d=> Math.max(0, d.cashEnd)), backgroundColor: '#10b981' },
                    { label: 'Voertuigen (Boekwaarde)', data: y.map(d=>d.book), backgroundColor: '#6366f1' }
                ]
            }, { scales: { x: { stacked: true }, y: { stacked: true } } });

            // 3. Liabilities (Stacked)
            updateChart('chart-liabilities', 'bar', {
                labels: labels,
                datasets: [
                    { label: 'Lease Verplichtingen', data: y.map(d=>d.liab), backgroundColor: '#ef4444' },
                    { label: 'Eigen Vermogen', data: y.map(d=> d.assets - d.liab), backgroundColor: '#3b82f6' }
                ]
            }, { scales: { x: { stacked: true }, y: { stacked: true } } });

            // 4. Monthly Cash
            updateChart('chart-cash-monthly', 'line', {
                labels: m.filter((_, i) => i%6===0).map(d => `M${d.monthIndex} '${d.yearLabel.toString().substr(2)}`),
                datasets: [
                    { label: 'Bankstand', data: m.filter((_, i) => i%6===0).map(d=>d.cash), borderColor: '#f59e0b', fill: true, backgroundColor: 'rgba(245, 158, 11, 0.1)' }
                ]
            });

             // 5. Cohorts
             updateChart('chart-cohorts', 'line', {
                labels: labels,
                datasets: [
                    { label: 'Totaal Vloot', data: y.map(d=>d.fleet), borderColor: '#3b82f6' },
                    { label: 'In Lease', data: y.map(d=>d.leased), borderColor: '#ef4444', borderDash: [5,5] },
                    { label: 'Eigendom (Vrij)', data: y.map(d=>d.fleet - d.leased), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true }
                ]
            });
        }

        function updateChart(id, type, data, options = {}) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: options.scales || { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, color: '#94a3b8' } } }
                }
            });
        }

        function renderPLTable(y) {
            const head = document.querySelector('#table-pl thead tr');
            const body = document.querySelector('#table-pl tbody');
            
            // Build Headers
            let hHtml = '<th class="text-left px-4 py-2 sticky left-0 bg-slate-900">Post</th>';
            y.forEach(d => hHtml += `<th class="px-2 py-2">${d.year}</th>`);
            head.innerHTML = hHtml;

            // Build Rows helper
            const addRow = (label, key, isBold=false, colorClass='') => {
                let html = `<td class="text-left px-4 py-2 sticky left-0 bg-slate-800 font-medium ${colorClass}">${label}</td>`;
                y.forEach(d => {
                    html += `<td class="px-2 py-2 ${isBold?'font-bold':''} ${colorClass}">${fmtMoney(d[key])}</td>`;
                });
                return `<tr>${html}</tr>`;
            };

            let rows = '';
            rows += addRow('Bruto Omzet', 'rev', true, 'text-white');
            rows += addRow('SnappCar Fee', 'fee', false, 'text-red-400');
            rows += addRow('Lease Kosten', 'lease', false, 'text-slate-400');
            rows += addRow('Operationeel', 'opex', false, 'text-slate-400');
            rows += addRow('Netto Winst', 'net', true, 'text-green-400');
            
            body.innerHTML = rows;
        }

        function renderFleetTable(y) {
            const body = document.getElementById('body-fleet');
            let html = '';
            y.forEach(d => {
                html += `<tr>
                    <td class="text-left px-4 py-2 text-white font-bold">${d.year}</td>
                    <td class="px-4 py-2 text-sky-400">${d.fleet}</td>
                    <td class="px-4 py-2 text-red-400">${d.leased}</td>
                    <td class="px-4 py-2 text-green-400 font-bold">${d.fleet - d.leased}</td>
                    <td class="px-4 py-2 text-slate-400">${fmtMoney(d.book)}</td>
                    <td class="px-4 py-2 text-slate-400">${fmtMoney(d.liab)}</td>
                </tr>`;
            });
            body.innerHTML = html;
        }

        function renderCashSummary(inv, div, y) {
            const last = y[y.length-1];
            const opsCash = last.cashEnd - inv + div; // Approx
            
            document.getElementById('summ-invest').innerText = fmtMoney(inv);
            document.getElementById('summ-div').innerText = fmtMoney(div);
            document.getElementById('summ-ops-cash').innerText = fmtMoney(opsCash);
            
            let advice = "Gezonde balans.";
            if(div > opsCash) advice = "Waarschuwing: U keert meer dividend uit dan de operatie genereert. Dit eet uw startkapitaal op.";
            if(opsCash < 0) advice = "Kritiek: De operatie verbrandt geld. Heroverweeg pricing of kostenstructuur.";
            if(inv < 50000) advice = "Let op: Startkapitaal is laag voor de beoogde groei. Liquiditeit is krap in jaar 1.";
            
            document.getElementById('cash-advice').innerText = advice;
        }

        function generateAdvice(m, y, mix) {
            const list = document.getElementById('advice-list');
            list.innerHTML = '';
            
            const add = (t, msg, type) => {
                const div = document.createElement('div');
                div.className = `p-3 rounded text-[10px] ${type==='good'?'advice-good':type==='warn'?'advice-warn':'advice-bad'}`;
                div.innerHTML = `<strong class="text-white block mb-1">${t}</strong><span class="text-slate-300">${msg}</span>`;
                list.appendChild(div);
            }

            // 1. Liquidity Dip Check
            let minCash = Math.min(...m.map(d=>d.cash));
            if(minCash < 0) {
                const dipMonth = m.find(d=>d.cash === minCash);
                add("‚ö†Ô∏è Liquiditeitstekort", `In ${dipMonth.yearLabel} (M${dipMonth.monthIndex+1}) duikt de cash naar ${fmtMoney(minCash)}. Verhoog startkapitaal of verlaag groei.`, 'bad');
            } else if (minCash < 10000) {
                add("‚ö†Ô∏è Krap bij kas", `Minimale cashpositie is ${fmtMoney(minCash)}. Dit is risicovol voor onvoorziene uitgaven.`, 'warn');
            } else {
                add("‚úÖ Liquide positie", "Cashflow blijft positief gedurende de hele simulatie.", 'good');
            }

            // 2. J-Curve
            const leaseFreeYear = y.findIndex(d => d.leased < d.fleet * 0.5);
            if(leaseFreeYear > -1) {
                add("üìà Kantelpunt Bereikt", `In ${y[leaseFreeYear].year} is >50% van de vloot eigendom. Winstgevendheid piekt hier.`, 'good');
            }

            // 3. Mix
            if(mix < 0.6) add("üõë Strategie Fout", "Te weinig bussen (<60%). Uw marge is te laag om overhead te dekken.", 'bad');

        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
             // Set defaults
             runModel();
        });

    </script>
</body>
</html>