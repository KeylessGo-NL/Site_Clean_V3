<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeylessGo Ultimate Fleet Intelligence v8.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        body { @apply bg-gray-50 text-slate-800 dark:bg-slate-950 dark:text-slate-200; font-size: 13px; }
        .panel { @apply bg-white border border-gray-200 dark:bg-slate-900 dark:border-slate-800 shadow-sm rounded-lg transition-colors; }
        .input-group label { @apply text-[10px] uppercase tracking-wider font-bold text-slate-500 dark:text-slate-500 block mb-1; }
        .input-field { @apply w-full bg-gray-50 border border-gray-300 text-slate-900 text-xs rounded px-2 py-1.5 focus:border-sky-500 focus:outline-none transition-colors font-mono dark:bg-slate-950 dark:border-slate-700 dark:text-white; }
        .tab-active { @apply border-b-2 border-sky-500 text-sky-600 bg-sky-50 dark:text-sky-400 dark:bg-sky-900/10; }
        .tab-inactive { @apply border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-gray-100 dark:text-slate-500 dark:hover:text-slate-300 dark:hover:bg-slate-800; }
        .metric-label { @apply text-[10px] uppercase font-bold text-slate-500 tracking-wider; }
        .metric-value { @apply text-xl font-mono font-bold text-slate-800 dark:text-white mt-1; }
        .risk-gauge { height: 6px; border-radius: 3px; background: #e2e8f0; dark:background-slate-700; overflow: hidden; margin-top: 8px; }
        .risk-fill { height: 100%; transition: width 0.5s ease; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 h-14 flex items-center justify-between px-6 flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-sky-600 to-blue-700 rounded flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-sky-900/50">KG</div>
            <div>
                <h1 class="font-bold text-sm text-slate-800 dark:text-white tracking-wide leading-tight">KeylessGo Fleet Intelligence</h1>
                <div class="text-[10px] text-sky-600 dark:text-sky-500 font-mono font-bold">v8.2 ULTIMATE (Light)</div>
            </div>
        </div>
        
        <div class="flex items-center gap-8 text-slate-600 dark:text-slate-400">
            <div class="flex flex-col items-end">
                <span class="text-[9px] uppercase text-slate-400 font-bold">Startdatum</span>
                <span class="text-xs font-mono font-bold text-slate-800 dark:text-white" id="disp-start-date">Maart 2026</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[9px] uppercase text-slate-400 font-bold">Horizon</span>
                <span class="text-xs font-mono font-bold text-slate-800 dark:text-white" id="disp-horizon">10 Jaar</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[9px] uppercase text-slate-400 font-bold">Betrouwbaarheid</span>
                <div class="flex items-center gap-2">
                    <div class="w-16 h-1.5 bg-gray-200 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="reliability-bar" class="h-full bg-green-500 w-3/4"></div>
                    </div>
                    <span class="text-xs font-bold text-green-600 dark:text-green-400" id="reliability-score">A</span>
                </div>
            </div>
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors" title="Toggle Theme">
                <!-- Sun (Dark Mode) -->
                <svg class="w-5 h-5 hidden dark:block text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon (Light Mode) -->
                <svg class="w-5 h-5 block dark:hidden text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- SIDEBAR: CONTROLS -->
        <aside class="w-80 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col overflow-y-auto z-10 custom-scrollbar">
            <div class="p-5 space-y-8 pb-20">
                
                <!-- Timing -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between border-b border-gray-200 dark:border-slate-800 pb-1">
                        <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2">üìÖ Tijdlijn</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Start Maand</label>
                            <select id="p-start-month" class="input-field" onchange="runModel()">
                                <option value="2" selected>Maart</option>
                                <option value="0">Januari</option>
                                <option value="5">Juni</option>
                                <option value="8">Sept</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Start Jaar</label>
                            <input type="number" id="p-start-year" class="input-field" value="2026" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Horizon (Jaren)</label>
                        <input type="range" id="p-horizon" min="3" max="15" value="10" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="runModel()">
                        <div class="text-right text-[10px] text-slate-500 dark:text-slate-400 mt-1 font-mono" id="val-horizon">10 Jaar</div>
                    </div>
                </div>

                <!-- Growth Strategy -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between border-b border-gray-200 dark:border-slate-800 pb-1">
                        <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2">üöÄ Groei & Mix</h3>
                    </div>
                    <div class="input-group">
                        <label>Start Vloot (Jaar 0)</label>
                        <input type="number" id="p-fleet-start" class="input-field" value="8" onchange="runModel()">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Groei Fase 1 (1-3jr)</label>
                            <input type="number" id="p-growth-1" class="input-field" value="5" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Groei Fase 2 (4jr+)</label>
                            <input type="number" id="p-growth-2" class="input-field" value="8" onchange="runModel()">
                        </div>
                    </div>
                    
                    <!-- Mix Slider -->
                    <div class="input-group pt-2">
                        <label>Vlootmix (Auto vs. Bus)</label>
                        <input type="range" id="p-mix" min="0" max="100" value="84" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" oninput="runModel()">
                        <div class="flex justify-between text-[10px] mt-1 font-mono">
                            <span class="text-emerald-600 dark:text-emerald-400 font-bold" id="val-mix-bus">84% Bus</span>
                            <span class="text-slate-500 dark:text-slate-400" id="val-mix-car">16% Auto</span>
                        </div>
                        <p class="text-[9px] text-slate-500 mt-1 leading-tight">Bus = Mix van Caddy (Small), Transporter (Med), Crafter (Large) volgens CSV profiel.</p>
                    </div>
                </div>

                <!-- Operations -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between border-b border-gray-200 dark:border-slate-800 pb-1">
                        <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2">‚öôÔ∏è Operatie & Prijzen</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Dagprijs Bus (‚Ç¨)</label>
                            <input type="number" id="p-price-bus" class="input-field" value="85" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Dagprijs Auto (‚Ç¨)</label>
                            <input type="number" id="p-price-car" class="input-field" value="45" onchange="runModel()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Target Bezetting (Jaargemiddelde)</label>
                        <input type="range" id="p-occ" min="20" max="70" value="38" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="runModel()">
                        <div class="text-right text-[10px] text-sky-600 dark:text-sky-400 mt-1 font-mono" id="val-occ">38%</div>
                    </div>
                    
                    <!-- Hidden but kept for logic compatibility if needed or expanded -->
                    <input type="hidden" id="p-price-idx" value="100"> 
                </div>

                <!-- Finance -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between border-b border-gray-200 dark:border-slate-800 pb-1">
                        <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2">üí∞ Finance</h3>
                    </div>
                    <div class="input-group">
                        <label>Start Kapitaal (‚Ç¨)</label>
                        <input type="number" id="p-capex-start" class="input-field" value="100000" step="5000" onchange="runModel()">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Extra Inv. Yr2</label>
                            <input type="number" id="p-capex-y2" class="input-field" value="15000" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Extra Inv. Yr4</label>
                            <input type="number" id="p-capex-y4" class="input-field" value="30000" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group pt-2">
                        <label>Dividend Payout (% van Winst)</label>
                        <input type="range" id="p-div" min="0" max="100" value="0" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500" oninput="runModel()">
                        <div class="text-right text-[10px] text-purple-600 dark:text-purple-400 mt-1 font-mono" id="val-div">0%</div>
                    </div>
                </div>

            </div>
        </aside>

        <!-- MAIN DASHBOARD AREA -->
        <main class="flex-1 flex flex-col min-w-0 bg-gray-50 dark:bg-slate-950 relative">
            
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 px-4 sticky top-0 z-10 backdrop-blur-sm">
                <button class="px-6 py-3 text-[11px] font-bold uppercase tracking-wider tab-active transition-all" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
                <button class="px-6 py-3 text-[11px] font-bold uppercase tracking-wider tab-inactive transition-all" onclick="switchTab('monthly', this)">üìÖ Maandelijkse Trends</button>
                <button class="px-6 py-3 text-[11px] font-bold uppercase tracking-wider tab-inactive transition-all" onclick="switchTab('financials', this)">üìë P&L & Balans</button>
                <button class="px-6 py-3 text-[11px] font-bold uppercase tracking-wider tab-inactive transition-all" onclick="switchTab('fleet', this)">üöê Vloot Detail</button>
            </div>

            <!-- Scrollable Views -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scrollbar">
                
                <!-- VIEW 1: DASHBOARD (Overview) -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    
                    <!-- KPI Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="panel p-4">
                            <h4 class="metric-label">Cumulatieve Netto Winst</h4>
                            <div class="metric-value text-emerald-600 dark:text-emerald-400" id="kpi-cum-profit">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-500 mt-1">Einde Looptijd (Na Belasting)</div>
                        </div>
                        <div class="panel p-4">
                            <h4 class="metric-label">Eind Cashpositie</h4>
                            <div class="metric-value" id="kpi-end-cash">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-500 mt-1">Liquide middelen</div>
                        </div>
                        <div class="panel p-4">
                            <h4 class="metric-label">Gemiddelde ROI</h4>
                            <div class="metric-value text-sky-600 dark:text-sky-400" id="kpi-roi">0%</div>
                            <div class="text-[10px] text-slate-500 mt-1">Jaarlijks rendement</div>
                        </div>
                        <div class="panel p-4">
                            <h4 class="metric-label">Vloot Activa Waarde</h4>
                            <div class="metric-value text-purple-600 dark:text-purple-400" id="kpi-assets">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-500 mt-1">Restwaarde Eigendom</div>
                        </div>
                    </div>

                    <!-- Main Chart & Advice -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="panel p-5 lg:col-span-2 shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase">Financi√´le Performance (Jaarlijks)</h3>
                                <div class="flex gap-2 text-[10px] text-slate-500">
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Omzet</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Winst</span>
                                </div>
                            </div>
                            <div class="h-80 w-full">
                                <canvas id="chart-annual-main"></canvas>
                            </div>
                        </div>
                        
                        <!-- Intelligent Advice Panel -->
                        <div class="panel p-5 flex flex-col shadow-lg border-t-4 border-t-sky-600 dark:border-t-sky-600">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Strategisch AI Advies
                            </h3>
                            <div id="advice-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar max-h-80">
                                <!-- Dynamic Content -->
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-100 dark:border-slate-800 text-[10px] text-slate-500">
                                <p class="font-bold mb-1">‚ö†Ô∏è Exogene Risico's (Niet in model):</p>
                                <ul class="list-disc pl-4 space-y-1">
                                    <li>Brandstofprijs schokken >15%</li>
                                    <li>Wijziging BPM/MRB regelgeving na 2028</li>
                                    <li>Macro-economische recessie (vraaguitval)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: MONTHLY TRENDS (Deep Dive) -->
                <div id="view-monthly" class="hidden space-y-6">
                    <div class="panel p-5">
                        <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-1">Maandelijkse Cashflow & Seizoensinvloeden</h3>
                        <p class="text-[10px] text-slate-500 mb-4">Toont de operationele realiteit incl. winterdips en investeringsmomenten.</p>
                        <div class="h-72 w-full">
                            <canvas id="chart-monthly-cash"></canvas>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="panel p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Operationele Kostenopbouw</h3>
                            <div class="h-64 w-full">
                                <canvas id="chart-monthly-opex"></canvas>
                            </div>
                        </div>
                        <div class="panel p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Vloot Lifecycle (Actieve KM)</h3>
                            <div class="h-64 w-full">
                                <canvas id="chart-monthly-km"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: FINANCIAL STATEMENTS -->
                <div id="view-financials" class="hidden space-y-8">
                    <div class="panel overflow-hidden">
                        <div class="bg-gray-100 dark:bg-slate-800/50 px-4 py-3 border-b border-gray-200 dark:border-slate-800 flex justify-between items-center">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase">Winst- en Verliesrekening (x ‚Ç¨1.000)</h3>
                            <button onclick="copyTable('table-pl')" class="text-[10px] text-sky-600 dark:text-sky-400 hover:text-sky-800 transition">Kopieer Data</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-[11px] font-mono" id="table-pl">
                                <thead class="bg-gray-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 font-bold border-b border-gray-200 dark:border-slate-800">
                                    <tr><th class="text-left px-4 py-3 sticky left-0 bg-gray-50 dark:bg-slate-900">Post</th><!-- Headers --></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-slate-800 text-slate-600 dark:text-slate-300"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW 4: FLEET DETAIL -->
                <div id="view-fleet" class="hidden space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="panel p-5 lg:col-span-2">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Vlootontwikkeling: Lease vs Eigendom</h3>
                            <div class="h-72 w-full">
                                <canvas id="chart-fleet-stack"></canvas>
                            </div>
                        </div>
                        <div class="panel p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Huidige Vlootprofielen</h3>
                            <div class="space-y-3">
                                <!-- Cards generated dynamically based on mix but hardcoded for visuals here -->
                                <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded border border-gray-200 dark:border-slate-700 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gray-200 dark:bg-slate-700 rounded flex items-center justify-center text-lg">üöê</div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-800 dark:text-white">VW Transporter (Med)</div>
                                        <div class="text-[10px] text-slate-500 dark:text-slate-400">Lease: ‚Ç¨310/mnd | Max: 340k km</div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded border border-gray-200 dark:border-slate-700 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gray-200 dark:bg-slate-700 rounded flex items-center justify-center text-lg">üöö</div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-800 dark:text-white">VW Crafter (Large)</div>
                                        <div class="text-[10px] text-slate-500 dark:text-slate-400">Lease: ‚Ç¨355/mnd | Max: 400k km</div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded border border-gray-200 dark:border-slate-700 flex items-center gap-3">
                                    <div class="w-10 h-10 bg-gray-200 dark:bg-slate-700 rounded flex items-center justify-center text-lg">üöó</div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-800 dark:text-white">VW Up! (Compact)</div>
                                        <div class="text-[10px] text-slate-500 dark:text-slate-400">Lease: ‚Ç¨180/mnd | Max: 260k km</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- SIMULATION LOGIC -->
    <script>
        // --- CONSTANTS FROM CSV DATA ---
        const VEHICLE_TYPES = {
            'compact': { name: 'VW Up!', price: 10000, lease: 180, ops: 60, dayRate: 45, maxKm: 260000, startKm: 100000, kmPerDay: 80, resPct: 0.20 },
            'small_van': { name: 'VW Caddy', price: 16000, lease: 220, ops: 90, dayRate: 55, maxKm: 320000, startKm: 100000, kmPerDay: 100, resPct: 0.20 },
            'med_van': { name: 'VW Transporter', price: 22700, lease: 310, ops: 110, dayRate: 75, maxKm: 340000, startKm: 100000, kmPerDay: 120, resPct: 0.25 },
            'large_van': { name: 'VW Crafter', price: 26000, lease: 355, ops: 130, dayRate: 90, maxKm: 400000, startKm: 100000, kmPerDay: 130, resPct: 0.25 }
        };

        const SEASONALITY = {
            'car': [0.92, 0.92, 1.02, 1.02, 1.02, 1.15, 1.15, 1.15, 0.98, 0.98, 0.92, 0.92], // Jan-Dec
            'van': [0.94, 0.94, 1.13, 1.13, 1.13, 1.10, 1.10, 1.10, 1.01, 1.01, 0.94, 0.94]
        };

        // --- STATE & UTILS ---
        let charts = {};
        const fmtMoney = (v) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
        const fmtK = (v) => Math.round(v/1000).toLocaleString('nl-NL');

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            runModel(); // Re-render charts
        }

        function switchTab(id, btn) {
            ['dashboard','monthly','financials','fleet'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('button').forEach(b => { 
                if(b.classList.contains('tab-active')){ 
                    b.classList.remove('tab-active'); b.classList.add('tab-inactive'); 
                }
            });
            btn.classList.remove('tab-inactive'); btn.classList.add('tab-active');
        }

        // --- MAIN ENGINE ---
        function runModel() {
            // 1. INPUTS
            const startMonth = parseInt(document.getElementById('p-start-month').value);
            const startYear = parseInt(document.getElementById('p-start-year').value);
            const horizon = parseInt(document.getElementById('p-horizon').value);
            const totalMonths = horizon * 12;

            // UI Label Updates
            const mNames = ["Jan", "Feb", "Mrt", "Apr", "Mei", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"];
            document.getElementById('disp-start-date').innerText = `${mNames[startMonth]} ${startYear}`;
            document.getElementById('disp-horizon').innerText = `${horizon} Jaar`;
            document.getElementById('val-horizon').innerText = `${horizon} Jaar`;

            const mixBusPct = parseInt(document.getElementById('p-mix').value) / 100;
            document.getElementById('val-mix-bus').innerText = Math.round(mixBusPct*100) + "% Bus";
            document.getElementById('val-mix-car').innerText = Math.round((1-mixBusPct)*100) + "% Auto";

            const occBase = parseInt(document.getElementById('p-occ').value) / 100;
            document.getElementById('val-occ').innerText = Math.round(occBase*100) + "%";

            // Note: Keeping p-price-idx in HTML hidden but logic can use it if needed. 
            // Here using explicit price inputs.
            const pBus = parseInt(document.getElementById('p-price-bus').value); 
            const pCar = parseInt(document.getElementById('p-price-car').value); 

            const divPct = parseInt(document.getElementById('p-div').value) / 100;
            document.getElementById('val-div').innerText = Math.round(divPct*100) + "%";

            // Growth Params
            const fleetStart = parseInt(document.getElementById('p-fleet-start').value);
            const growth1 = parseInt(document.getElementById('p-growth-1').value);
            const growth2 = parseInt(document.getElementById('p-growth-2').value);

            // Capital
            const capexStart = parseInt(document.getElementById('p-capex-start').value);
            const capexY2 = parseInt(document.getElementById('p-capex-y2').value);
            const capexY4 = parseInt(document.getElementById('p-capex-y4').value);

            // --- SIMULATION LOOP ---
            
            // Initial State
            let cash = capexStart;
            let totalInvested = capexStart;
            let activeFleet = []; // Array of vehicle objects
            
            // Outputs
            const mData = [];
            
            // Helper to add vehicle
            const addVehicle = (monthAcq, type) => {
                const def = VEHICLE_TYPES[type];
                return {
                    type: type,
                    acqMonth: monthAcq,
                    km: def.startKm,
                    maxKm: def.maxKm,
                    leaseCost: def.lease,
                    price: def.price,
                    resPct: def.resPct,
                    active: true,
                    leaseEnd: monthAcq + 60,
                    isLeased: true
                };
            };

            // Init Fleet (Month 0)
            // Distribute bus mix according to CSV logical split: Small(30%), Med(50%), Large(20%) of Bus portion
            const busCount = Math.round(fleetStart * mixBusPct);
            const carCount = fleetStart - busCount;
            
            const splitBus = (n) => {
                const large = Math.floor(n * 0.2);
                const small = Math.floor(n * 0.3);
                const med = n - large - small;
                return { s: small, m: med, l: large };
            };

            const initB = splitBus(busCount);
            for(let i=0; i<carCount; i++) activeFleet.push(addVehicle(0, 'compact'));
            for(let i=0; i<initB.s; i++) activeFleet.push(addVehicle(0, 'small_van'));
            for(let i=0; i<initB.m; i++) activeFleet.push(addVehicle(0, 'med_van'));
            for(let i=0; i<initB.l; i++) activeFleet.push(addVehicle(0, 'large_van'));

            // Loop
            for (let m = 0; m < totalMonths; m++) {
                const curMonthIdx = (startMonth + m) % 12;
                const yearIdx = Math.floor(m / 12);
                const isJan = curMonthIdx === 0;

                // 1. Growth (Yearly in Jan)
                if (m > 0 && isJan) {
                    const g = yearIdx < 3 ? growth1 : growth2;
                    const newBus = Math.round(g * mixBusPct);
                    const newCar = g - newBus;
                    const bSplit = splitBus(newBus);
                    
                    for(let i=0; i<newCar; i++) activeFleet.push(addVehicle(m, 'compact'));
                    for(let i=0; i<bSplit.s; i++) activeFleet.push(addVehicle(m, 'small_van'));
                    for(let i=0; i<bSplit.m; i++) activeFleet.push(addVehicle(m, 'med_van'));
                    for(let i=0; i<bSplit.l; i++) activeFleet.push(addVehicle(m, 'large_van'));
                }

                // 2. Capital Injections
                if (m === 12) { cash += capexY2; totalInvested += capexY2; }
                if (m === 36) { cash += capexY4; totalInvested += capexY4; }

                // 3. Operational Logic per Vehicle
                let mRev = 0;
                let mLease = 0;
                let mOps = 0;
                let mReplacements = 0;
                let mActiveCount = 0;
                let mLeasedCount = 0;
                let mAssetValue = 0;
                let mKmTotal = 0;

                const inflator = Math.pow(1.025, yearIdx); // 2.5% inflation

                activeFleet.forEach((v, idx) => {
                    if (!v.active) return;

                    // Lifecycle Check
                    if (v.km >= v.maxKm) {
                        v.active = false;
                        // Sell Asset (Residual Value Cash In)
                        const residual = v.price * v.resPct; // Conservative scrap/export value
                        cash += residual;
                        mReplacements++;
                        // Immediate Replacement (New Lease)
                        activeFleet.push(addVehicle(m, v.type)); 
                        return;
                    }

                    mActiveCount++;
                    const def = VEHICLE_TYPES[v.type];
                    const isVan = v.type !== 'compact';
                    
                    // Seasonality
                    const seasonFactor = isVan ? SEASONALITY.van[curMonthIdx] : SEASONALITY.car[curMonthIdx];
                    
                    // Revenue Calculation
                    const age = m - v.acqMonth;
                    const ramp = age < 3 ? 0.7 : 1.0;
                    
                    const effOcc = Math.min(0.70, occBase * seasonFactor * ramp);
                    const days = 30.5 * effOcc;
                    // Use override price if set, else def.dayRate
                    const basePrice = isVan ? pBus : pCar;
                    const rev = days * basePrice * inflator;
                    mRev += rev;

                    // Mileage
                    const km = days * def.kmPerDay;
                    v.km += km;
                    mKmTotal += km;

                    // Lease Cost
                    if (m < v.leaseEnd) {
                        mLease += def.lease;
                        mLeasedCount++;
                    } else {
                        v.isLeased = false;
                    }

                    // Ops Cost (Maintenance + Ins + Tires)
                    // Increases with age/km
                    let ops = def.ops * inflator;
                    if (v.km > 150000) ops *= 1.3;
                    if (v.km > 250000) ops *= 1.5;
                    // Fixed Insurance add-on per vehicle (SnappCar insurance usually var, but assume base fixed cost + fee)
                    const fixedIns = 45 * inflator; 
                    mOps += ops + fixedIns;

                    // Asset Value (Linear Depr)
                    const residual = v.price * v.resPct;
                    const depr = (v.price - residual) / 60; // 5 year depr
                    const val = Math.max(residual, v.price - (Math.min(age, 60) * depr));
                    mAssetValue += val;
                });

                // 4. Global Costs
                const fee = mRev * 0.30; // SnappCar Fee
                const staffCount = Math.ceil(mActiveCount / 25); // 1 FTE per 25 cars
                const staffCost = (staffCount * 3500) * inflator; // 3500/mo cost
                const marketing = (mActiveCount * 25) * inflator;
                const overhead = 500 * inflator;

                const opex = mOps + staffCost + marketing + overhead;
                const ebitda = mRev - fee - opex;
                const ebit = ebitda - mLease;
                
                // Tax (Carry forward losses simplified: just tax positive months for sim visual)
                const tax = ebit > 0 ? ebit * 0.19 : 0; 
                const net = ebit - tax;

                // Cashflow
                cash += net;

                // Dividend (Annual in Dec)
                if (curMonthIdx === 11 && divPct > 0 && net > 0) {
                    const annualProfitEst = net * 12; // Crude
                    const div = Math.min(cash - 20000, annualProfitEst * divPct); // Keep 20k buffer
                    if (div > 0) cash -= div;
                }

                mData.push({
                    month: m,
                    label: `M${m+1}`,
                    year: startYear + yearIdx,
                    rev: mRev,
                    net: net,
                    cash: cash,
                    km: mKmTotal,
                    leaseCost: mLease,
                    fee: fee,
                    opex: opex,
                    fleet: mActiveCount,
                    leased: mLeasedCount,
                    owned: mActiveCount - mLeasedCount,
                    assets: mAssetValue
                });
            }

            // --- 3. AGGREGATE YEARLY ---
            const yData = [];
            let yt = { rev:0, net:0, km:0 };
            mData.forEach((d, i) => {
                yt.rev += d.rev; yt.net += d.net; yt.km += d.km;
                if ((i+1)%12 === 0 || i===mData.length-1) {
                    yData.push({
                        year: d.year,
                        rev: yt.rev,
                        net: yt.net,
                        km: yt.km,
                        cash: d.cash, // snapshot
                        fleet: d.fleet,
                        leased: d.leased,
                        owned: d.owned,
                        assets: d.assets
                    });
                    yt = { rev:0, net:0, km:0 };
                }
            });

            // --- 4. RENDER UI ---
            renderDashboard(mData, yData, totalInvested);
            renderFinancials(yData);
            calculateReliability(mData, yData, totalInvested);
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard(m, y, inv) {
            const last = y[y.length-1];
            const cumProfit = m.reduce((a,b)=>a+b.net,0);
            
            // KPIs
            document.getElementById('kpi-cum-profit').innerText = fmtMoney(cumProfit);
            document.getElementById('kpi-end-cash').innerText = fmtMoney(last.cash);
            document.getElementById('kpi-end-cash').className = last.cash < 0 ? "metric-value text-red-500" : "metric-value text-slate-800 dark:text-white";
            
            const avgProfit = cumProfit / y.length;
            const roi = (avgProfit / inv) * 100;
            document.getElementById('kpi-roi').innerText = roi.toFixed(1) + "%";
            document.getElementById('kpi-assets').innerText = fmtMoney(last.assets);

            // Chart 1: Annual Overview
            updateChart('chart-annual-main', {
                labels: y.map(d=>d.year),
                datasets: [
                    { type: 'line', label: 'Netto Winst', data: y.map(d=>d.net), borderColor: '#10b981', borderWidth: 3, tension: 0.3, order: 1, pointBackgroundColor: '#0f172a' },
                    { type: 'bar', label: 'Omzet', data: y.map(d=>d.rev), backgroundColor: '#3b82f6', order: 2, borderRadius: 4 }
                ]
            }, true);

            // Chart 2: Monthly Cash (Detail)
            // Downsample for visual clarity if too long
            const filterStep = m.length > 60 ? 2 : 1;
            const mFilt = m.filter((_,i)=>i%filterStep===0);
            updateChart('chart-monthly-cash', {
                labels: mFilt.map(d=>d.label),
                datasets: [{ 
                    label: 'Bankstand', 
                    data: mFilt.map(d=>d.cash), 
                    borderColor: '#f59e0b', 
                    backgroundColor: (ctx) => {
                        const gradient = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                        gradient.addColorStop(0, 'rgba(245, 158, 11, 0.4)');
                        gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');
                        return gradient;
                    },
                    fill: true, pointRadius: 0, borderWidth: 2
                }]
            });

            // Chart 3: OPEX Stack (Monthly)
            const mYear1 = m.slice(0, 24); // Show first 2 years details
            updateChart('chart-monthly-opex', {
                labels: mYear1.map(d=>d.label),
                datasets: [
                    { label: 'Lease', data: mYear1.map(d=>d.leaseCost), backgroundColor: '#64748b' },
                    { label: 'Platform Fee', data: mYear1.map(d=>d.fee), backgroundColor: '#ef4444' },
                    { label: 'Operationeel', data: mYear1.map(d=>d.opex), backgroundColor: '#6366f1' }
                ]
            }, false, true);

            // Chart 4: Fleet Stack
            updateChart('chart-fleet-stack', {
                labels: y.map(d=>d.year),
                datasets: [
                    { label: 'In Lease (Schuld)', data: y.map(d=>d.leased), backgroundColor: '#f59e0b' },
                    { label: 'Eigendom (Vrij)', data: y.map(d=>d.owned), backgroundColor: '#10b981' }
                ]
            }, false, true);

            // Chart 5: Active KM
            updateChart('chart-monthly-km', {
                labels: y.map(d=>d.year),
                datasets: [{ label: 'Jaarkilometrage Vloot', data: y.map(d=>d.km), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true }]
            }, false); // Line
        }

        function renderFinancials(y) {
            const tbody = document.querySelector('#table-pl tbody');
            const thead = document.querySelector('#table-pl thead tr');
            
            // Build Head
            let hHtml = '<th class="text-left px-4 py-3 sticky left-0 bg-gray-50 dark:bg-slate-900 z-10">Post</th>';
            y.forEach(d => hHtml += `<th class="px-2 py-2">${d.year}</th>`);
            thead.innerHTML = hHtml;

            // Build Rows
            const addRow = (lbl, key, bold=false) => {
                let html = `<tr><td class="text-left px-4 py-2 sticky left-0 bg-gray-50 dark:bg-slate-900 border-r border-slate-300 dark:border-slate-800 ${bold?'font-bold text-slate-900 dark:text-white':'text-slate-500 dark:text-slate-400'}">${lbl}</td>`;
                y.forEach(d => html += `<td class="px-2 py-2 text-slate-600 dark:text-slate-300 ${bold?'font-bold':''}">${fmtK(d[key])}</td>`);
                return html + '</tr>';
            }

            let html = '';
            html += addRow('Omzet (Bruto)', 'rev', true);
            html += addRow('Netto Winst', 'net', true);
            html += addRow('Cash Eind', 'cash');
            html += addRow('Vloot Grootte', 'fleet');
            html += addRow('Vaste Activa', 'assets');
            tbody.innerHTML = html;
        }

        function calculateReliability(m, y, inv) {
            const list = document.getElementById('advice-list');
            list.innerHTML = '';
            const add = (t, txt, type) => list.innerHTML += `<div class="p-3 rounded text-[11px] mb-2 ${type==='good'?'advice-good':type==='warn'?'advice-warn':'advice-bad'}"><strong class="block mb-1 font-bold opacity-90">${t}</strong><span class="opacity-80">${txt}</span></div>`;

            // Logic
            let score = 100;
            const minCash = Math.min(...m.map(d=>d.cash));
            
            // 1. Liquidity
            if (minCash < 0) {
                score -= 40;
                add("Kritiek: Liquiditeit", `In ${m.find(d=>d.cash<0).label} duikt de cashflow in het rood. Verhoog startkapitaal of verlaag groei in jaar 1.`, "bad");
            } else if (minCash < 15000) {
                score -= 15;
                add("Risico: Krap bij kas", `Minimale buffer is slechts ${fmtMoney(minCash)}. Een kleine tegenvaller kan fataal zijn.`, "warn");
            } else {
                add("Liquiditeit", "Gezonde cashbuffer gehandhaafd.", "good");
            }

            // 2. Mix
            const fleetEnd = y[y.length-1];
            const mixRatio = parseInt(document.getElementById('p-mix').value);
            if (mixRatio < 60) {
                score -= 20;
                add("Strategie: Marge Druk", "Te veel personenauto's drukken de winstgevendheid. Focus op LCV's voor hogere ROI.", "warn");
            }

            // 3. J-Curve
            const year5Profit = y[4] ? y[4].net : 0;
            const year1Profit = y[0].net;
            if (year5Profit > year1Profit * 1.5) {
                add("J-Curve Effect", "Duidelijke winstversnelling zichtbaar na aflopen eerste leases.", "good");
            }

            // Update Gauge
            const bar = document.getElementById('reliability-bar');
            const txt = document.getElementById('reliability-score');
            
            if(score >= 80) { bar.className = "h-full bg-emerald-500 transition-all"; txt.className="text-xs font-bold text-emerald-600 dark:text-emerald-400"; txt.innerText="A (Uitstekend)"; }
            else if(score >= 60) { bar.className = "h-full bg-sky-500 transition-all"; txt.className="text-xs font-bold text-sky-600 dark:text-sky-400"; txt.innerText="B (Goed)"; }
            else if(score >= 40) { bar.className = "h-full bg-amber-500 transition-all"; txt.className="text-xs font-bold text-amber-600 dark:text-amber-400"; txt.innerText="C (Risicovol)"; }
            else { bar.className = "h-full bg-red-500 transition-all"; txt.className="text-xs font-bold text-red-600 dark:text-red-400"; txt.innerText="D (Kritiek)"; }
            
            bar.style.width = score + "%";
        }

        // Chart Helper
        function updateChart(id, conf, mixed=false, stacked=false) {
            const ctx = document.getElementById(id).getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const colorGrid = isDark ? '#334155' : '#e2e8f0';
            const colorText = isDark ? '#94a3b8' : '#64748b';

            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: mixed ? 'bar' : (conf.datasets[0].type || 'bar'),
                data: conf,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { stacked: stacked, grid: { color: colorGrid }, ticks: { color: colorText } },
                        x: { stacked: stacked, grid: { display: false }, ticks: { color: colorText, maxTicksLimit: 12 } }
                    },
                    plugins: { legend: { labels: { color: colorText, boxWidth: 10 } } }
                }
            });
        }

        // Init
        window.addEventListener('DOMContentLoaded', runModel);
    </script>
</body>
</html>