<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeylessGo Ultimate Strategy Simulator v6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        body { @apply bg-gray-50 text-slate-800 dark:bg-slate-950 dark:text-e2e8f0; transition: background-color 0.3s; }
        
        /* Panel Styles */
        .panel { @apply bg-white border border-gray-200 dark:bg-slate-800 dark:border-slate-700 shadow-sm transition-colors duration-300; }
        
        /* Input Styles */
        .input-group label { @apply text-[0.65rem] uppercase tracking-wider font-bold text-slate-500 dark:text-slate-400 block mb-1; }
        .input-field { @apply w-full bg-gray-50 border border-gray-300 text-slate-900 text-xs rounded px-2 py-1 focus:border-sky-500 focus:outline-none dark:bg-slate-900 dark:border-slate-600 dark:text-white transition-colors; font-family: 'JetBrains Mono', monospace; }
        
        /* Tabs */
        .tab-active { @apply border-b-2 border-sky-500 text-sky-600 bg-sky-50 dark:bg-sky-900/20 dark:text-sky-400; }
        .tab-inactive { @apply border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-gray-100 dark:text-slate-400 dark:hover:text-slate-300 dark:hover:bg-slate-800; }

        /* Advice Cards */
        .advice-good { @apply border-l-4 border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-200; }
        .advice-warn { @apply border-l-4 border-amber-500 bg-amber-50 dark:bg-amber-900/20 text-amber-900 dark:text-amber-200; }
        .advice-bad { @apply border-l-4 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-200; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 dark:text-slate-200">

    <!-- Top Bar -->
    <header class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 h-14 flex items-center justify-between px-6 flex-shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-sky-600 rounded flex items-center justify-center text-white font-bold text-sm shadow-lg">KG</div>
            <div>
                <h1 class="font-bold text-sm tracking-wide leading-tight">KeylessGo Strategy Sim</h1>
                <div class="text-[10px] text-sky-600 dark:text-sky-400 font-mono font-bold">v6.0 PRO EDITION</div>
            </div>
        </div>
        <div class="flex items-center gap-6 text-xs font-mono text-slate-500 dark:text-slate-400">
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Startdatum</span>
                <span id="disp-start-date" class="font-bold text-slate-700 dark:text-white">Maart 2026</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Horizon</span>
                <span id="disp-horizon" class="font-bold text-slate-700 dark:text-white">10 Jaar</span>
            </div>
            
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors" title="Toggle Theme">
                <!-- Sun Icon (Show in Dark) -->
                <svg class="w-5 h-5 hidden dark:block text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Moon Icon (Show in Light) -->
                <svg class="w-5 h-5 block dark:hidden text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden bg-gray-100 dark:bg-slate-950">
        
        <!-- SIDEBAR: PARAMETERS -->
        <aside class="w-80 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col overflow-y-auto z-10 custom-scrollbar shadow-xl">
            <div class="p-4 space-y-6 pb-20">
                
                <!-- Group 0: Timing -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2 border-b border-gray-200 dark:border-slate-800 pb-1">
                        <span class="text-sky-500">üìÖ</span> Tijdlijn
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Start Maand</label>
                            <select id="p-start-month" class="input-field" onchange="runModel()">
                                <option value="0">Januari</option>
                                <option value="2" selected>Maart</option>
                                <option value="5">Juni</option>
                                <option value="8">September</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Start Jaar</label>
                            <input type="number" id="p-start-year" class="input-field" value="2026" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Horizon (Jaren)</label>
                        <input type="range" id="p-horizon" min="3" max="15" value="10" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="runModel()">
                        <div class="text-right text-xs text-slate-500 dark:text-slate-400 mt-1 font-mono" id="val-horizon">10 Jaar</div>
                    </div>
                </div>

                <!-- Group 1: Strategic Assets -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2 border-b border-gray-200 dark:border-slate-800 pb-1">
                        <span class="text-sky-500">üöÄ</span> Groeistrategie
                    </h3>
                    
                    <div class="input-group">
                        <label>Start Vloot (Jaar 0)</label>
                        <input type="number" id="p-fleet-start" class="input-field" value="10" onchange="runModel()">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Groei/Jr (Fase 1: Yr 1-3)</label>
                            <input type="number" id="p-growth-1" class="input-field" value="4" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Groei/Jr (Fase 2: Yr 4+)</label>
                            <input type="number" id="p-growth-2" class="input-field" value="6" onchange="runModel()">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Vlootmix: Busjes (%)</label>
                        <input type="range" id="p-mix" min="0" max="100" value="70" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="runModel()">
                        <div class="flex justify-between text-xs mt-1 font-mono">
                            <span class="text-sky-600 dark:text-sky-400 font-bold" id="val-mix">70% Bus</span>
                            <span class="text-slate-400">30% Auto</span>
                        </div>
                    </div>
                </div>

                <!-- Group 2: Unit Economics -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2 border-b border-gray-200 dark:border-slate-800 pb-1">
                        <span class="text-sky-500">üí∂</span> Pricing & Assets
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Dagprijs Bus (‚Ç¨)</label>
                            <input type="number" id="p-price-bus" class="input-field" value="85" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Dagprijs Auto (‚Ç¨)</label>
                            <input type="number" id="p-price-car" class="input-field" value="45" onchange="runModel()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Bezetting (Gemiddeld %)</label>
                        <input type="range" id="p-occ" min="15" max="65" value="38" class="w-full h-1 bg-gray-300 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-sky-500" oninput="runModel()">
                        <div class="text-right text-xs text-sky-600 dark:text-sky-400 mt-1 font-mono font-bold" id="val-occ">38%</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="input-group">
                            <label>Restwaarde Bus %</label>
                            <input type="number" id="p-resid-bus" class="input-field" value="25" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Restwaarde Auto %</label>
                            <input type="number" id="p-resid-car" class="input-field" value="20" onchange="runModel()">
                        </div>
                    </div>
                </div>

                <!-- Group 3: Operationele Kosten -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2 border-b border-gray-200 dark:border-slate-800 pb-1">
                        <span class="text-sky-500">‚öôÔ∏è</span> Organisatie
                    </h3>
                    <div class="input-group">
                        <label>Personeel: 1 FTE per X auto's</label>
                        <input type="number" id="p-staff-ratio" class="input-field" value="25" onchange="runModel()">
                    </div>
                    <div class="input-group">
                        <label>Kosten per FTE (‚Ç¨/Jaar)</label>
                        <input type="number" id="p-salary" class="input-field" value="45000" step="1000" onchange="runModel()">
                    </div>
                    <div class="input-group mt-2">
                        <label>Marketing (‚Ç¨/Auto/Maand)</label>
                        <input type="number" id="p-marketing" class="input-field" value="30" onchange="runModel()">
                    </div>
                </div>

                <!-- Group 4: Finance -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-slate-800 dark:text-white flex items-center gap-2 border-b border-gray-200 dark:border-slate-800 pb-1">
                        <span class="text-sky-500">üí∞</span> Kapitaal
                    </h3>
                    <div class="input-group">
                        <label>Start Investering (‚Ç¨)</label>
                        <input type="number" id="p-capex-start" class="input-field" value="100000" step="10000" onchange="runModel()">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <div class="input-group">
                            <label>Extra Inv. (Yr 2)</label>
                            <input type="number" id="p-capex-y2" class="input-field" value="0" step="10000" onchange="runModel()">
                        </div>
                        <div class="input-group">
                            <label>Dividend (%)</label>
                            <input type="number" id="p-dividend" class="input-field" value="0" max="100" onchange="runModel()">
                        </div>
                    </div>
                </div>

            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 flex flex-col min-w-0">
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-4 sticky top-0 z-10">
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-active transition" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-inactive transition" onclick="switchTab('financials', this)">üìë P&L & Balans</button>
                <button class="px-5 py-3 text-xs font-bold uppercase tracking-wide tab-inactive transition" onclick="switchTab('fleet', this)">üöê Vloot Detail</button>
            </div>

            <!-- Views -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
                
                <!-- VIEW 1: DASHBOARD -->
                <div id="view-dashboard" class="space-y-6 animate-fade-in">
                    <!-- Top KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider">Cumulatieve Winst</h4>
                            <div class="text-2xl font-mono font-bold text-slate-800 dark:text-white mt-1" id="kpi-cum-profit">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-400 mt-1">Na belasting (Einde looptijd)</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider">Eind Cashpositie</h4>
                            <div class="text-2xl font-mono font-bold text-slate-800 dark:text-white mt-1" id="kpi-end-cash">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-400 mt-1">Liquiditeit op balans</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider">Gem. ROI / Jaar</h4>
                            <div class="text-2xl font-mono font-bold text-slate-800 dark:text-white mt-1" id="kpi-roi">0%</div>
                            <div class="text-[10px] text-slate-400 mt-1">Op totaal ge√Ønvesteerd vermogen</div>
                        </div>
                        <div class="panel rounded-lg p-4">
                            <h4 class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider">Eind Vlootwaarde</h4>
                            <div class="text-2xl font-mono font-bold text-slate-800 dark:text-white mt-1" id="kpi-asset-val">‚Ç¨ 0</div>
                            <div class="text-[10px] text-slate-400 mt-1">Boekwaarde eigendom</div>
                        </div>
                    </div>

                    <!-- Main Chart Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="panel rounded-lg p-5 lg:col-span-2 shadow-md">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Financi√´le Performance (Omzet vs Winst)</h3>
                            <div class="h-80 w-full relative">
                                <canvas id="chart-main"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5 flex flex-col shadow-md">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Strategisch Advies (AI Logic)</h3>
                            <div id="advice-list" class="flex-1 overflow-y-auto space-y-3 pr-1 custom-scrollbar max-h-80 text-xs">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>

                    <!-- Extra Analysis Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Liquiditeitsprognose (Maandelijks)</h3>
                            <div class="h-64 w-full">
                                <canvas id="chart-cash-monthly"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Kostenverdeling (Geaggregeerd)</h3>
                            <div class="h-64 w-full flex items-center justify-center">
                                <div class="w-64 h-64">
                                    <canvas id="chart-cost-pie"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: FINANCIAL STATEMENTS -->
                <div id="view-financials" class="hidden space-y-8">
                    
                    <!-- P&L Table -->
                    <div class="panel rounded-lg overflow-hidden shadow-md">
                        <div class="bg-gray-50 dark:bg-slate-800 px-4 py-3 border-b border-gray-200 dark:border-slate-700 flex justify-between items-center">
                            <h3 class="text-slate-700 dark:text-white font-bold text-xs uppercase">Winst- en Verliesrekening (x ‚Ç¨1.000)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-xs font-mono" id="table-pl">
                                <thead class="bg-gray-100 dark:bg-slate-900 text-slate-500 dark:text-slate-400 font-bold border-b border-gray-200 dark:border-slate-700">
                                    <tr>
                                        <th class="text-left px-4 py-3">Post</th>
                                        <!-- Years headers generated by JS -->
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 dark:divide-slate-800 text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-800">
                                    <!-- Rows generated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Balance Sheet Visual -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Balans: Activa (Bezittingen)</h3>
                            <div class="h-64">
                                <canvas id="chart-assets"></canvas>
                            </div>
                        </div>
                        <div class="panel rounded-lg p-5">
                            <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Balans: Passiva (Schulden & EV)</h3>
                            <div class="h-64">
                                <canvas id="chart-liabilities"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: FLEET -->
                <div id="view-fleet" class="hidden space-y-6">
                    <div class="panel rounded-lg p-5">
                        <h3 class="text-slate-800 dark:text-white font-bold text-xs uppercase mb-4">Vlootontwikkeling & Eigendom</h3>
                        <p class="text-xs text-slate-500 mb-4">Deze grafiek toont de shift van lease (schuld) naar eigendom (asset).</p>
                        <div class="h-80 w-full">
                            <canvas id="chart-cohorts"></canvas>
                        </div>
                    </div>
                    <div class="panel rounded-lg overflow-hidden shadow-md">
                         <div class="overflow-x-auto">
                            <table class="w-full text-right text-xs font-mono" id="table-fleet">
                                <thead class="bg-gray-100 dark:bg-slate-900 text-slate-500 dark:text-slate-400 font-bold border-b border-gray-200 dark:border-slate-700">
                                    <tr>
                                        <th class="text-left px-4 py-3">Jaar</th>
                                        <th>Totaal Vloot</th>
                                        <th>In Lease</th>
                                        <th>Eigendom</th>
                                        <th>Personeel (FTE)</th>
                                        <th>Boekwaarde</th>
                                        <th>Lease Schuld</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 dark:divide-slate-800 text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-800" id="body-fleet">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- SIMULATION ENGINE -->
    <script>
        // --- GLOBAL CHART INSTANCES ---
        let charts = {};

        // --- UTILS ---
        const fmtMoney = (val) => new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
        const fmtK = (val) => Math.round(val/1000);

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            // Re-render charts to update colors
            runModel(); 
        }

        function switchTab(viewId, btn) {
            ['dashboard', 'financials', 'fleet'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            document.getElementById('view-'+viewId).classList.remove('hidden');
            document.querySelectorAll('button').forEach(b => {
                if(b.classList.contains('tab-active')) {
                    b.classList.remove('tab-active');
                    b.classList.add('tab-inactive');
                }
            });
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
        }

        // --- MAIN SIMULATION LOGIC ---
        function runModel() {
            // 1. GET INPUTS
            const startMonth = parseInt(document.getElementById('p-start-month').value);
            const startYear = parseInt(document.getElementById('p-start-year').value);
            const horizonYears = parseInt(document.getElementById('p-horizon').value);
            
            // UI Updates
            const monthNames = ["Jan", "Feb", "Mrt", "Apr", "Mei", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"];
            document.getElementById('disp-start-date').innerText = `${monthNames[startMonth]} ${startYear}`;
            document.getElementById('disp-horizon').innerText = `${horizonYears} Jaar`;
            document.getElementById('val-horizon').innerText = `${horizonYears} Jaar`;
            document.getElementById('val-occ').innerText = document.getElementById('p-occ').value + "%";
            const mixVal = document.getElementById('p-mix').value;
            document.getElementById('val-mix').innerText = `${mixVal}% Bus`;

            // Core Params
            const fleetStart = parseInt(document.getElementById('p-fleet-start').value);
            const growth1 = parseInt(document.getElementById('p-growth-1').value); // Yr 1-3
            const growth2 = parseInt(document.getElementById('p-growth-2').value); // Yr 4+
            const mixBusPct = parseInt(document.getElementById('p-mix').value) / 100;
            
            const priceBus = parseInt(document.getElementById('p-price-bus').value);
            const priceCar = parseInt(document.getElementById('p-price-car').value);
            const occBase = parseInt(document.getElementById('p-occ').value) / 100;
            const resBusPct = parseInt(document.getElementById('p-resid-bus').value) / 100;
            const resCarPct = parseInt(document.getElementById('p-resid-car').value) / 100;

            const staffRatio = parseInt(document.getElementById('p-staff-ratio').value);
            const salary = parseInt(document.getElementById('p-salary').value);
            const mktPerCar = parseInt(document.getElementById('p-marketing').value);
            
            const capexStart = parseInt(document.getElementById('p-capex-start').value);
            const capexY2 = parseInt(document.getElementById('p-capex-y2').value);
            const dividendPct = parseInt(document.getElementById('p-dividend').value) / 100;

            // Assumptions
            const feePct = 0.30;
            const inflation = 0.025;
            const taxRate = 0.19;
            const ASSET_BUS = 35000; const ASSET_CAR = 20000;
            const LEASE_BUS = 450; const LEASE_CAR = 255;
            const OPS_BUS = 80; const OPS_CAR = 60;
            const INS = 48; // Fixed ops

            // --- SIMULATION LOOP ---
            const totalMonths = horizonYears * 12;
            const monthlyData = [];
            
            // State
            let currentFleet = fleetStart;
            let cash = capexStart;
            let retainedEarnings = 0;
            
            // Cohorts: { type, mAcq, cost, leaseEnd }
            let cohorts = [];
            
            // Init Fleet
            const initBus = Math.round(fleetStart * mixBusPct);
            for(let i=0; i<initBus; i++) cohorts.push({ type: 'b', mAcq: 0, cost: ASSET_BUS, leaseEnd: 60 });
            for(let i=0; i<(fleetStart-initBus); i++) cohorts.push({ type: 'c', mAcq: 0, cost: ASSET_CAR, leaseEnd: 60 });

            for (let m = 0; m < totalMonths; m++) {
                const yearIdx = Math.floor(m / 12);
                const isJan = (startMonth + m) % 12 === 0;
                
                // Growth Logic (Jan of each year, skip year 0 start)
                if (m > 0 && isJan) {
                    const growth = yearIdx < 3 ? growth1 : growth2;
                    const newBus = Math.round(growth * mixBusPct);
                    const newCar = growth - newBus;
                    for(let k=0; k<newBus; k++) cohorts.push({ type: 'b', mAcq: m, cost: ASSET_BUS, leaseEnd: m+60 });
                    for(let k=0; k<newCar; k++) cohorts.push({ type: 'c', mAcq: m, cost: ASSET_CAR, leaseEnd: m+60 });
                    currentFleet += growth;
                }

                // Extra Capex (Month 12)
                if (m === 12) cash += capexY2;

                const inflator = Math.pow(1 + inflation, yearIdx);
                
                // Monthly Revenue & Fleet Costs
                let mRev = 0;
                let mLease = 0;
                let mOps = 0;
                let mBookVal = 0;
                let mLeaseDebt = 0;
                let activeLeases = 0;

                cohorts.forEach(c => {
                    const isBus = c.type === 'b';
                    const price = isBus ? priceBus : priceCar;
                    
                    // Ramp up
                    const age = m - c.mAcq;
                    const ramp = age < 3 ? 0.7 : 1.0;
                    const occ = Math.min(0.55, occBase + (yearIdx * 0.01)); // Slight efficiency gain/yr
                    
                    mRev += price * 30.5 * occ * ramp * inflator;

                    if (m < c.leaseEnd) {
                        mLease += isBus ? LEASE_BUS : LEASE_CAR;
                        activeLeases++;
                        // Debt
                        mLeaseDebt += (c.leaseEnd - m) * (isBus ? LEASE_BUS : LEASE_CAR);
                    }

                    // Ops
                    let ops = (isBus ? OPS_BUS : OPS_CAR) * inflator;
                    if (age > 60) ops *= 1.5; // Old cars cost more
                    mOps += ops + INS;

                    // Book Value
                    const residPct = isBus ? resBusPct : resCarPct;
                    const resid = c.cost * residPct;
                    const deprMo = (c.cost - resid) / 60;
                    const val = Math.max(resid, c.cost - (Math.min(age, 60) * deprMo));
                    mBookVal += val;
                });

                // Global Costs
                const fee = mRev * feePct;
                const mkt = currentFleet * mktPerCar * inflator;
                
                // Staffing (Step function)
                const fte = Math.ceil(currentFleet / staffRatio);
                const staffCost = (fte * salary / 12) * inflator;

                const opex = mOps + mkt + staffCost;
                const ebitda = mRev - fee - opex;
                const ebit = ebitda - mLease; // Lease as proxy for depr+interest
                
                let tax = ebit > 0 ? ebit * taxRate : 0;
                const net = ebit - tax;

                cash += net;

                // Dividend (Dec only)
                let div = 0;
                if ((startMonth + m) % 12 === 11 && net > 0 && cash > 25000) {
                    div = (net * 12) * dividendPct; 
                    if(div > (cash - 25000)) div = 0; // Protect liquidity
                    cash -= div;
                }

                monthlyData.push({
                    idx: m,
                    year: startYear + yearIdx,
                    rev: mRev,
                    costTotal: fee + mLease + opex + tax,
                    fee: fee,
                    lease: mLease,
                    staff: staffCost,
                    opex: opex,
                    net: net,
                    cash: cash,
                    assets: cash + mBookVal,
                    liab: mLeaseDebt,
                    fleet: currentFleet,
                    leased: activeLeases,
                    fte: fte,
                    bookVal: mBookVal
                });
            }

            // --- AGGREGATION ---
            const yearlyData = [];
            let yt = { rev:0, fee:0, lease:0, staff:0, opex:0, net:0, costTotal:0 };
            
            monthlyData.forEach((d, i) => {
                yt.rev += d.rev; yt.fee += d.fee; yt.lease += d.lease; yt.staff += d.staff; yt.opex += d.opex; yt.net += d.net; yt.costTotal += d.costTotal;
                
                if ((i+1)%12 === 0 || i === monthlyData.length-1) {
                    yearlyData.push({
                        year: d.year,
                        rev: yt.rev,
                        fee: yt.fee,
                        lease: yt.lease,
                        staff: yt.staff,
                        net: yt.net,
                        cash: d.cash, // snapshot
                        assets: d.assets,
                        liab: d.liab,
                        fleet: d.fleet,
                        leased: d.leased,
                        fte: d.fte,
                        book: d.bookVal,
                        costBreakdown: [yt.fee, yt.lease, yt.staff, yt.opex - yt.staff]
                    });
                    yt = { rev:0, fee:0, lease:0, staff:0, opex:0, net:0, costTotal:0 };
                }
            });

            renderDashboard(yearlyData, monthlyData, capexStart);
        }

        // --- RENDER ---
        function renderDashboard(y, m, inv) {
            const isDark = document.documentElement.classList.contains('dark');
            const colorText = isDark ? '#e2e8f0' : '#1e293b';
            const colorGrid = isDark ? '#334155' : '#e2e8f0';

            // 1. KPIs
            const last = y[y.length-1];
            const cumNet = y.reduce((a,b)=>a+b.net, 0);
            document.getElementById('kpi-cum-profit').innerText = fmtMoney(cumNet);
            document.getElementById('kpi-end-cash').innerText = fmtMoney(last.cash);
            document.getElementById('kpi-end-cash').className = last.cash < 0 ? "text-2xl font-mono font-bold text-red-500 mt-1" : `text-2xl font-mono font-bold mt-1 ${isDark?'text-white':'text-slate-800'}`;
            
            const roi = ((cumNet / y.length) / inv) * 100;
            document.getElementById('kpi-roi').innerText = roi.toFixed(1) + '%';
            document.getElementById('kpi-asset-val').innerText = fmtMoney(last.book);

            // 2. Main Chart (Combined Bar/Line) - FORCE ORDER
            updateChart('chart-main', {
                labels: y.map(d=>d.year),
                datasets: [
                    { type: 'line', label: 'Netto Winst', data: y.map(d=>d.net), borderColor: '#10b981', borderWidth: 3, pointBackgroundColor: isDark?'#fff':'#10b981', tension: 0.3, order: 1 },
                    { type: 'bar', label: 'Omzet', data: y.map(d=>d.rev), backgroundColor: '#3b82f6', order: 2 },
                    { type: 'bar', label: 'Totale Kosten', data: y.map(d=> -d.costTotal), backgroundColor: '#ef4444', order: 3 } // Negative for visual contrast
                ]
            }, true); // Stacked X? No.

            // 3. Cash Monthly
            updateChart('chart-cash-monthly', {
                labels: m.filter((_,i)=>i%6===0).map(d=>`M${d.idx}`),
                datasets: [{ 
                    label: 'Bankstand', 
                    data: m.filter((_,i)=>i%6===0).map(d=>d.cash), 
                    borderColor: '#f59e0b', 
                    backgroundColor: 'rgba(245, 158, 11, 0.1)', 
                    fill: true, 
                    pointRadius: 0 
                }]
            });

            // 4. Cost Pie (Aggregated)
            const totFee = y.reduce((a,b)=>a+b.fee, 0);
            const totLease = y.reduce((a,b)=>a+b.lease, 0);
            const totStaff = y.reduce((a,b)=>a+b.staff, 0);
            const totOps = y.reduce((a,b)=>a+b.net, 0); // Just for sizing? No, calculate total cost pie.
            // Re-calc totals
            const totals = y.reduce((acc, curr) => {
                acc[0] += curr.costBreakdown[0]; // Fee
                acc[1] += curr.costBreakdown[1]; // Lease
                acc[2] += curr.costBreakdown[2]; // Staff
                acc[3] += curr.costBreakdown[3]; // Other Ops
                return acc;
            }, [0,0,0,0]);

            const ctxPie = document.getElementById('chart-cost-pie').getContext('2d');
            if(charts['pie']) charts['pie'].destroy();
            charts['pie'] = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Platform Fee', 'Lease', 'Personeel', 'Ops & Mkt'],
                    datasets: [{ data: totals, backgroundColor: ['#ef4444', '#64748b', '#f59e0b', '#6366f1'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: colorText, boxWidth: 10 } } } }
            });

            // 5. Balance Sheet Charts
            updateChart('chart-assets', {
                labels: y.map(d=>d.year),
                datasets: [
                    { label: 'Liquiditeit', data: y.map(d=>Math.max(0, d.cash)), backgroundColor: '#10b981' },
                    { label: 'Vaste Activa (Vloot)', data: y.map(d=>d.book), backgroundColor: '#3b82f6' }
                ]
            }, false, true); // Stacked

            updateChart('chart-liabilities', {
                labels: y.map(d=>d.year),
                datasets: [
                    { label: 'Lease Verplichting', data: y.map(d=>d.liab), backgroundColor: '#ef4444' },
                    { label: 'Eigen Vermogen', data: y.map(d=> d.assets - d.liab), backgroundColor: '#6366f1' }
                ]
            }, false, true);

            // 6. Fleet Cohort
            updateChart('chart-cohorts', {
                labels: y.map(d=>d.year),
                datasets: [
                    { label: 'Totaal Vloot', data: y.map(d=>d.fleet), borderColor: '#3b82f6', tension: 0.1 },
                    { label: 'Leasevrij (Eigendom)', data: y.map(d=>d.fleet-d.leased), backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, borderColor: '#10b981' }
                ]
            });

            // 7. Tables & Advice
            renderTables(y);
            generateAdvice(m, y);
        }

        function updateChart(id, data, mixed=false, stacked=false) {
            const ctx = document.getElementById(id).getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const colorGrid = isDark ? '#334155' : '#e2e8f0';
            const colorText = isDark ? '#94a3b8' : '#64748b';

            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: mixed ? 'bar' : data.datasets[0].type || 'bar', // Base type
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { stacked: stacked, grid: { color: colorGrid }, ticks: { color: colorText } },
                        x: { stacked: stacked, grid: { display: false }, ticks: { color: colorText } }
                    },
                    plugins: { legend: { labels: { color: colorText } } }
                }
            });
        }

        function renderTables(y) {
            // P&L
            let h = '<th class="text-left px-4 py-3 sticky left-0 bg-gray-100 dark:bg-slate-900 z-10">Post</th>';
            y.forEach(d => h += `<th class="px-2 py-3 min-w-[80px]">${d.year}</th>`);
            document.querySelector('#table-pl thead tr').innerHTML = h;

            const row = (lbl, key, k=1) => {
                let s = `<tr><td class="text-left px-4 py-2 font-medium sticky left-0 bg-white dark:bg-slate-800 border-r border-gray-100 dark:border-slate-700">${lbl}</td>`;
                y.forEach(d => s += `<td class="px-2 py-2 text-slate-500 dark:text-slate-400">${fmtK(d[key]*k)}</td>`);
                return s + '</tr>';
            }
            let b = '';
            b += row('Omzet', 'rev');
            b += row('Platform Fee', 'fee');
            b += row('Lease Kosten', 'lease');
            b += row('Personeel', 'staff');
            b += `<tr><td class="text-left px-4 py-2 font-bold sticky left-0 bg-white dark:bg-slate-800 border-r border-gray-100 dark:border-slate-700 text-slate-800 dark:text-white border-t border-gray-200 dark:border-slate-700">Netto Winst</td>`;
            y.forEach(d => b += `<td class="px-2 py-2 font-bold border-t border-gray-200 dark:border-slate-700 ${d.net>0?'text-emerald-500':'text-red-500'}">${fmtK(d.net)}</td>`);
            b += '</tr>';
            document.querySelector('#table-pl tbody').innerHTML = b;

            // Fleet
            let f = '';
            y.forEach(d => {
                f += `<tr>
                    <td class="text-left px-4 py-2 font-bold">${d.year}</td>
                    <td class="px-4 py-2 text-sky-500 font-bold">${d.fleet}</td>
                    <td class="px-4 py-2 text-amber-500">${d.leased}</td>
                    <td class="px-4 py-2 text-emerald-500">${d.fleet - d.leased}</td>
                    <td class="px-4 py-2 text-slate-400">${d.fte}</td>
                    <td class="px-4 py-2 text-slate-400">${fmtMoney(d.book)}</td>
                    <td class="px-4 py-2 text-red-400">${fmtMoney(d.liab)}</td>
                </tr>`;
            });
            document.getElementById('body-fleet').innerHTML = f;
        }

        function generateAdvice(m, y) {
            const list = document.getElementById('advice-list');
            list.innerHTML = '';
            const add = (t, txt, type) => {
                list.innerHTML += `<div class="p-3 rounded text-[11px] mb-2 ${type==='good'?'advice-good':type==='warn'?'advice-warn':'advice-bad'}"><strong class="block mb-1 font-bold opacity-90">${t}</strong><span class="opacity-80">${txt}</span></div>`;
            }

            // Liquidity
            const minCash = Math.min(...m.map(d=>d.cash));
            if(minCash < 0) add("CRITISCH: Cashflow Tekort", "U komt liquide middelen tekort. Verhoog startkapitaal of verlaag groei in fase 1.", "bad");
            else if(minCash < 20000) add("Waarschuwing: Krap bij kas", `Minimale buffer is slechts ${fmtMoney(minCash)}. Risico bij tegenvallers.`, "warn");
            else add("Liquiditeit OK", "Gezonde cashbuffer gedurende de hele periode.", "good");

            // Profitability
            if(y[1].net < 0) add("Aanloopverliezen", "Jaar 2 is nog verlieslatend. Dit is normaal, maar bewaak de burn-rate.", "warn");
            
            // J-Curve
            const jCurveYear = y.findIndex(d => d.net > y[0].net * 2);
            if(jCurveYear > 0) add("J-Curve Effect", `Winstverdubbeling zichtbaar in ${y[jCurveYear].year} door schaalvoordeel en vrijval lease.`, "good");

            // Staff efficiency
            const revPerFTE = y[y.length-1].rev / y[y.length-1].fte;
            if(revPerFTE < 150000) add("Personeels efficiency", "Omzet per FTE is aan de lage kant. Overweeg automatisering of hogere ratio.", "warn");
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            runModel();
        });
    </script>
</body>
</html>